<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Time Bank - Cosmic Pulse Evolution</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --accent-color: #00f2ff;
        }

        body {
            background: radial-gradient(circle at center, #0a0a1a 0%, #020205 100%);
            color: white;
            font-family: 'Inter', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; overflow-x: hidden; user-select: none;
            touch-action: manipulation;
            padding-top: var(--safe-top);
            box-sizing: border-box;
        }

        #starCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        header {
            position: absolute; top: var(--safe-top); width: 100%;
            display: flex; align-items: center; justify-content: center; height: 60px; z-index: 100;
        }

        .logo-text {
            font-size: 24px; font-weight: 900; letter-spacing: 4px; color: #ffffff;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(0, 242, 255, 0.3);
            display: flex; align-items: center;
        }
        .logo-text span { color: var(--accent-color); margin-right: 4px; }

        .menu-trigger {
            position: absolute; left: 20px; cursor: pointer;
            width: 30px; height: 30px; display: flex; flex-direction: column; justify-content: center; gap: 6px;
        }
        .menu-trigger span { width: 100%; height: 2px; background: white; transition: 0.3s; }
        
        .side-menu {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: rgba(10, 10, 26, 0.95); backdrop-filter: blur(15px);
            z-index: 200; transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            padding: 80px 30px; box-sizing: border-box; border-right: 1px solid rgba(255,255,255,0.1);
        }
        .side-menu.open { left: 0; box-shadow: 20px 0 50px rgba(0,0,0,0.5); }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 150; }
        
        .menu-section { margin-bottom: 40px; }
        .menu-section h3 { font-size: 12px; color: var(--accent-color); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 15px; opacity: 0.8; }
        .menu-item { color: #888; text-decoration: none; display: block; padding: 10px 0; font-size: 15px; cursor: pointer; transition: 0.3s; }
        .menu-item.active { color: white; font-weight: bold; }
        .desc-text { font-size: 13px; line-height: 1.6; color: #aaa; white-space: pre-wrap; }
        .desc-highlight { color: #fff; font-weight: bold; display: block; margin-bottom: 15px; font-size: 15px; }

        .alert-toggle { position: absolute; top: 15px; right: 20px; cursor: pointer; width: 30px; height: 30px; opacity: 0.4; transition: 0.3s; z-index: 100; }
        .alert-toggle.active { opacity: 1; }
        .bell-icon { width: 20px; height: 20px; border: 2px solid white; border-radius: 10px 10px 2px 2px; position: relative; margin: 2px auto; }
        .bell-icon::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 6px; height: 4px; background: white; border-radius: 0 0 3px 3px; }
        .mute-line { position: absolute; top: 50%; left: 50%; width: 34px; height: 2px; background: #ff3b30; transform: translate(-50%, -50%) rotate(45deg); display: none; }
        .is-muted .mute-line { display: block; }

        #alertOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        @keyframes pulse-red {
            0% { box-shadow: inset 0 0 40px rgba(255, 59, 48, 0); }
            50% { box-shadow: inset 0 0 120px rgba(255, 59, 48, 0.4); }
            100% { box-shadow: inset 0 0 40px rgba(255, 59, 48, 0); }
        }
        .alert-active { animation: pulse-red 2s infinite ease-in-out; }

        .app-wrapper { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; max-width: 800px; margin-top: 40px; }
        .quick-controls { display: flex; flex-direction: column; gap: 12px; }
        .btn-quick { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #888; width: 55px; padding: 10px 0; border-radius: 8px; cursor: pointer; font-size: 11px; transition: all 0.2s; touch-action: manipulation; }
        .btn-quick:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.2); color: #fff; }

        .timer-container { position: relative; width: 450px; height: 450px; display: flex; align-items: center; justify-content: center; }
        #timerCanvas { position: absolute; top: 0; left: 0; z-index: 5; max-width: 100%; height: auto; }
        .timer-info { text-align: center; z-index: 10; pointer-events: none; }
        .status-label { font-size: 16px; letter-spacing: 2px; height: 24px; margin-bottom: 5px; padding-top: 15px; font-weight: bold; color: white; }
        .pulse-text { animation: soft-pulse 2.5s infinite ease-in-out; }
        @keyframes soft-pulse { 0%, 100% { opacity: 0.2; transform: scale(0.98); } 50% { opacity: 1; transform: scale(1); } }
        .time-main { font-size: 52px; font-weight: bold; line-height: 1; letter-spacing: 2px; }
        .time-sub-m { font-size: 28px; opacity: 0.8; margin-top: 5px; }
        .time-sub-ms { font-size: 18px; opacity: 0.5; font-family: monospace; }

        .bottom-area { margin-top: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .controls { display: flex; align-items: center; gap: 50px; height: 80px; }
        .btn-start-wrap { text-align: center; width: 75px; cursor: pointer; background: none; border: none; color: white; transition: 0.2s; touch-action: manipulation; }
        .btn-start-wrap span { font-size: 32px; display: block; font-weight: 200; }
        .btn-start-wrap label { font-size: 11px; opacity: 0.8; cursor: pointer; letter-spacing: 1px; display: block; }
        .btn-pause { width: 65px; height: 65px; background-color: #ff3b30; border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(255, 59, 48, 0.4); opacity: 0; transform: scale(0.5); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); visibility: hidden; touch-action: manipulation; }
        .btn-pause.show { visibility: visible; opacity: 1; transform: scale(1); }
        .clear-btn { background: transparent; border: 1px solid #333; color: #555; padding: 8px 60px; border-radius: 10px; cursor: pointer; font-size: 11px; letter-spacing: 2px; transition: 0.3s; touch-action: manipulation; }

        @media (max-width: 600px) {
            body { justify-content: flex-start; }
            header { height: 50px; }
            .logo-text { font-size: 18px; letter-spacing: 3px; }
            .app-wrapper { flex-direction: column; gap: 15px; margin-top: 60px; }
            .timer-container { width: 300px; height: 300px; order: 1; }
            #timerCanvas { width: 300px; height: 300px; }
            .time-main { font-size: 36px; }
            .quick-controls { flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 8px; order: 2; width: 95%; }
            .btn-quick { width: 70px; padding: 12px 0; font-size: 12px; }
            .bottom-area { order: 3; margin-top: 15px; }
        }
    </style>
</head>
<body>
    <canvas id="starCanvas"></canvas>

    <header>
        <div class="menu-trigger" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </div>
        <div class="logo-text">TIME<span>BANK</span></div>
        <div class="alert-toggle active" id="alertToggle" onclick="toggleMute()">
            <div class="bell-icon"></div>
            <div class="mute-line"></div>
        </div>
    </header>

    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-section">
            <h3 id="langHeader">Language</h3>
            <div id="btnJp" class="menu-item active" onclick="setLanguage('ja')">日本語</div>
            <div id="btnEn" class="menu-item" onclick="setLanguage('en')">English</div>
        </div>
        <div class="menu-section">
            <h3 id="devHeader">DEVELOPMENT</h3>
            <div id="devDesc" class="desc-text"></div>
        </div>
    </div>

    <div id="alertOverlay"></div>

    <div class="app-wrapper">
        <div class="quick-controls">
            <button class="btn-quick" onclick="addTime(-1800)">-30m</button>
            <button class="btn-quick" onclick="addTime(-900)">-15m</button>
            <button class="btn-quick" onclick="addTime(-300)">-5m</button>
            <button class="btn-quick" onclick="addTime(-60)">-1m</button>
        </div>

        <div class="timer-container">
            <canvas id="timerCanvas" width="450" height="450"></canvas>
            <div class="timer-info" id="timerInfo">
                <div id="statusLabel" class="status-label"></div>
                <div id="timeMain" class="time-main">00:00</div>
                <div id="timeSubM" class="time-sub-m">00</div>
                <div id="timeSubMs" class="time-sub-ms">00</div>
            </div>
        </div>

        <div class="quick-controls">
            <button class="btn-quick" onclick="addTime(1800)">+30m</button>
            <button class="btn-quick" onclick="addTime(900)">+15m</button>
            <button class="btn-quick" onclick="addTime(300)">+5m</button>
            <button class="btn-quick" onclick="addTime(60)">+1m</button>
        </div>
    </div>

    <div class="bottom-area">
        <div class="controls">
            <button class="btn-start-wrap" onclick="startTimer('minus')">
                <span>ー</span><label id="labelUse">使う</label>
            </button>
            <button id="pauseBtn" class="btn-pause" onclick="pauseTimer()">||</button>
            <button class="btn-start-wrap" onclick="startTimer('plus')">
                <span>＋</span><label id="labelCharge">貯める</label>
            </button>
        </div>
        <button id="resetBtn" class="clear-btn" onclick="clearTime()">リセット</button>
    </div>

    <script>
        const translations = {
            ja: {
                use: "使う", charge: "貯める", reset: "リセット", using: "使用中", charging: "チャージ中", shortage: "時間が足りません",
                devHeader: "DEVELOPMENT",
                devDesc: "<span class='desc-highlight'>「全力で学び、全力で遊ぼう」</span>\n\nTime Bankは、子どもたちの時間を「貯める」「使う」という概念で視覚化し、日々の活動をゲームのように管理・改善するためのツールです。",
                timeOver: "時間終了", left: "残り", minutes: "分", voiceLang: "ja-JP"
            },
            en: {
                use: "USE", charge: "CHARGE", reset: "RESET", using: "USING", charging: "CHARGING", shortage: "TIME SHORTAGE",
                devHeader: "DEVELOPMENT",
                devDesc: "<span class='desc-highlight'>\"Learn Hard, Play Hard\"</span>\n\nTime Bank is a tool to visualize time as 'saving' and 'spending,' helping children manage and improve their daily activities like a game.",
                timeOver: "Time over", left: "", minutes: "minutes left", voiceLang: "en-US"
            }
        };

        let currentLang = 'ja';
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('labelUse').innerText = translations[lang].use;
            document.getElementById('labelCharge').innerText = translations[lang].charge;
            document.getElementById('resetBtn').innerText = translations[lang].reset;
            document.getElementById('devHeader').innerText = translations[lang].devHeader;
            document.getElementById('devDesc').innerHTML = translations[lang].devDesc;
            document.getElementById('btnJp').classList.toggle('active', lang === 'ja');
            document.getElementById('btnEn').classList.toggle('active', lang === 'en');
            updateUI();
        }

        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('open');
            overlay.style.display = menu.classList.contains('open') ? 'block' : 'none';
        }

        let actualMs = 0, visualMs = 0, timerId = null, mode = null, lastTimestamp = 0, isMuted = false, lastAnnouncedSec = null, particles = [], rotationAngle = 0;
        const timerCanvas = document.getElementById('timerCanvas'), ctx = timerCanvas.getContext('2d');
        const starCanvas = document.getElementById('starCanvas'), sctx = starCanvas.getContext('2d');
        const pauseBtn = document.getElementById('pauseBtn'), statusLabel = document.getElementById('statusLabel');
        const cyberGradients = [['#00f2ff', '#0066ff'], ['#00d4ff', '#0044ff'], ['#7000ff', '#4b0082'], ['#ff00f2', '#b000ff']];
        
        let stars = [];
        let shootingStars = [];

        function initStars() {
            starCanvas.width = window.innerWidth; starCanvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 150; i++) {
                stars.push({ x: Math.random() * starCanvas.width, y: Math.random() * starCanvas.height, size: Math.random() * 1.5, vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2, opacity: Math.random() });
            }
        }
        window.addEventListener('resize', initStars); initStars();

        function createShootingStar() {
            const startX = Math.random() * starCanvas.width;
            const startY = Math.random() * (starCanvas.height / 2);
            const angle = Math.PI / 4 + (Math.random() - 0.5) * 0.2;
            const speed = 10 + Math.random() * 15;
            shootingStars.push({ x: startX, y: startY, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, opacity: 1.0 });
        }

        function drawStars() {
            sctx.clearRect(0, 0, starCanvas.width, starCanvas.height);
            stars.forEach(s => {
                s.x += s.vx; s.y += s.vy;
                if (s.x < 0) s.x = starCanvas.width; if (s.x > starCanvas.width) s.x = 0;
                if (s.y < 0) s.y = starCanvas.height; if (s.y > starCanvas.height) s.y = 0;
                sctx.beginPath(); sctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                sctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`; sctx.fill();
            });
            if (Math.random() < 1 / (60 * 30)) createShootingStar();
            shootingStars = shootingStars.filter(ss => {
                ss.x += ss.vx; ss.y += ss.vy; ss.opacity -= 0.02;
                if (ss.opacity <= 0) return false;
                sctx.beginPath();
                const grad = sctx.createLinearGradient(ss.x, ss.y, ss.x - ss.vx * 2, ss.y - ss.vy * 2);
                grad.addColorStop(0, `rgba(255, 255, 255, ${ss.opacity})`);
                grad.addColorStop(1, `rgba(255, 255, 255, 0)`);
                sctx.strokeStyle = grad; sctx.lineWidth = 2;
                sctx.moveTo(ss.x, ss.y); sctx.lineTo(ss.x - ss.vx * 2, ss.y - ss.vy * 2);
                sctx.stroke();
                return true;
            });
        }

        class Particle {
            constructor(type, color = '#ffffff') {
                this.type = type; 
                this.cx = timerCanvas.width / 2; 
                this.cy = timerCanvas.height / 2;
                this.color = color; 
                this.angle = Math.random() * Math.PI * 2;
                this.friction = 1.0;
                
                if (type === 'in') { 
                    this.radius = 220 + Math.random() * 50; 
                    this.speed = 0.005 + Math.random() * 0.01; 
                    this.radialSpeed = 0.8 + Math.random() * 0.5; 
                    this.life = 1.0;
                } else if (type === 'out') { 
                    this.radius = Math.random() * 20; 
                    this.speed = (Math.random() - 0.5) * 0.02; 
                    this.radialSpeed = 1.2 + Math.random() * 2; 
                    this.life = 1.0;
                } else if (type === 'explode') {
                    this.radius = Math.random() * 10;
                    this.radialSpeed = 5 + Math.random() * 10;
                    this.friction = 0.95; 
                    this.life = 1.0;
                }
                this.size = Math.random() * 2.0 + 0.5;
            }

            update() {
                if (this.type === 'in') { 
                    this.angle += this.speed; this.radius -= this.radialSpeed; 
                    this.life = Math.min(1.0, (this.radius - 40) / 100); 
                } else if (this.type === 'out') { 
                    this.angle += this.speed; this.radius += this.radialSpeed; 
                    this.life = (this.radius < 50) ? 0.2 : 1.0 - (this.radius / 250); 
                } else if (this.type === 'explode') {
                    this.radialSpeed *= this.friction;
                    this.radius += this.radialSpeed;
                    this.life -= 0.015;
                }
                this.x = this.cx + Math.cos(this.angle) * this.radius; 
                this.y = this.cy + Math.sin(this.angle) * this.radius;
                return this.life > 0.01 && this.radius < 400 && (this.type === 'in' ? this.radius > 30 : true);
            }

            draw() { 
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); 
                ctx.fillStyle = this.color; ctx.globalAlpha = this.life * 0.8; ctx.fill(); ctx.globalAlpha = 1.0; 
            }
        }

        function explode(count, color) {
            for (let i = 0; i < count; i++) {
                particles.push(new Particle('explode', color));
            }
        }

        function requestNotificationPermission() {
            if ("Notification" in window) {
                Notification.requestPermission();
            }
        }

        function startTimer(newMode) {
            if (timerId) cancelAnimationFrame(timerId);
            requestNotificationPermission();
            mode = newMode;
            pauseBtn.classList.add('show');
            lastTimestamp = performance.now();
            const tick = (now) => {
                const delta = now - lastTimestamp; lastTimestamp = now;
                actualMs += (mode === 'plus' ? delta : -delta);
                if (mode === 'plus' && Math.random() > 0.3) particles.push(new Particle('in'));
                else if (mode === 'minus' && Math.random() > 0.35) particles.push(new Particle('out'));
                checkCountdown(); timerId = requestAnimationFrame(tick);
            };
            timerId = requestAnimationFrame(tick);
        }

        function toggleMute() { isMuted = !isMuted; document.getElementById('alertToggle').classList.toggle('is-muted', isMuted); }
        function speak(text) { if (!isMuted) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = translations[currentLang].voiceLang; window.speechSynthesis.speak(u); } }

        function checkCountdown() {
            const currentSec = Math.floor(actualMs / 1000);
            if (mode === 'minus' && currentSec !== lastAnnouncedSec) {
                if (currentSec === 0) {
                    explode(150, '#ff3b30');
                    speak(translations[currentLang].timeOver);
                    if ("Notification" in window && Notification.permission === "granted") {
                        new Notification("TIME BANK", { body: translations[currentLang].timeOver, silent: false });
                    }
                } else if ([600, 300, 60].includes(currentSec)) {
                    const msg = `${translations[currentLang].left} ${Math.abs(currentSec/60)} ${translations[currentLang].minutes}`;
                    speak(msg);
                }
                lastAnnouncedSec = currentSec;
            }
        }

        function pauseTimer() {
            cancelAnimationFrame(timerId); timerId = null; mode = null;
            pauseBtn.classList.remove('show');
        }

        function clearTime() { 
            if (Math.abs(actualMs) > 1000) explode(100, '#ffffff');
            pauseTimer(); actualMs = 0; visualMs = 0; lastAnnouncedSec = null; 
        }

        function addTime(amount) {
            actualMs += amount * 1000;
            for(let i=0; i<15; i++) particles.push(new Particle(amount > 0 ? 'in' : 'out'));
        }

        function animate() {
            visualMs += (actualMs - visualMs) * 0.15;
            if (mode === 'plus') rotationAngle += 0.008;
            else if (mode === 'minus') rotationAngle -= 0.015;
            else rotationAngle += 0.002;
            drawStars(); updateUI(); drawTimer(); requestAnimationFrame(animate);
        }

        function updateUI() {
            const absMs = Math.abs(Math.round(visualMs));
            const h = Math.floor(absMs / 3600000), m = Math.floor((absMs % 3600000) / 60000), s = Math.floor((absMs % 60000) / 1000), ms = Math.floor((absMs % 1000) / 10);
            document.getElementById('timeMain').innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            document.getElementById('timeSubM').innerText = String(s).padStart(2, '0');
            document.getElementById('timeSubMs').innerText = String(ms).padStart(2, '0');
            
            const isNegative = actualMs < 0;
            const label = document.getElementById('statusLabel');

            if (isNegative) {
                label.innerText = translations[currentLang].shortage;
                label.style.color = '#ff3b30';
                label.classList.add('pulse-text');
            } else if (mode === 'plus') {
                label.innerText = translations[currentLang].charging;
                label.style.color = 'white';
                label.classList.add('pulse-text');
            } else if (mode === 'minus') {
                label.innerText = translations[currentLang].using;
                label.style.color = 'white';
                label.classList.add('pulse-text');
            } else {
                label.innerText = "";
                label.classList.remove('pulse-text');
            }

            document.getElementById('alertOverlay').classList.toggle('alert-active', isNegative);
            document.querySelectorAll('.time-main, .time-sub-m').forEach(el => el.style.color = isNegative ? '#ff3b30' : 'white');
        }

        function drawTimer() {
            ctx.clearRect(0, 0, timerCanvas.width, timerCanvas.height);
            let cx = timerCanvas.width / 2, cy = timerCanvas.height / 2;
            const time = performance.now();
            const pulseRate = (actualMs < 0) ? 250 : 800;
            const pulse = (Math.sin(time / pulseRate) + 1) / 2;
            const totalRings = 6;
            for (let i = 0; i < totalRings; i++) {
                ctx.beginPath(); ctx.arc(cx, cy, 125 + (i * 18), 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 255, 255, 0.03)`; ctx.stroke();
            }
            const totalSeconds = visualMs / 1000, absSec = Math.abs(totalSeconds);
            const activeGradients = (totalSeconds >= 0) ? cyberGradients : [['#FF4D4D', '#B30000']];
            for (let i = 0; i < totalRings; i++) {
                const radius = 125 + (i * 18), hourInSec = 3600;
                let progress = Math.max(0, Math.min(1, (absSec - i * hourInSec) / hourInSec));
                if (progress > 0) {
                    ctx.save(); ctx.translate(cx, cy); ctx.rotate(rotationAngle * (1 + i * 0.15));
                    ctx.beginPath();
                    if (totalSeconds >= 0) ctx.arc(0, 0, radius, 0, Math.PI * 2 * progress);
                    else ctx.arc(0, 0, radius, 0, -Math.PI * 2 * progress, true);
                    ctx.lineWidth = ((totalSeconds < 0) ? 4.5 : 3.0) + (pulse * (totalSeconds < 0 ? 3.0 : 2.0));
                    ctx.shadowBlur = (totalSeconds < 0 ? 15 : 8) + (pulse * 12);
                    ctx.shadowColor = activeGradients[i % activeGradients.length][0];
                    ctx.strokeStyle = activeGradients[i % activeGradients.length][0];
                    ctx.lineCap = 'round'; ctx.stroke(); ctx.restore();
                }
            }
            particles = particles.filter(p => { if (p.update()) { p.draw(); return true; } return false; });
        }
        
        setLanguage('ja');
        animate();
    </script>
</body>
</html>
