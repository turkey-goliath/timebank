<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Bank - Cosmic Pulse Evolution</title>
    <style>
        body {
            background: radial-gradient(circle at center, #0a0a1a 0%, #020205 100%);
            color: white;
            font-family: 'Inter', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; overflow-x: hidden; user-select: none;
        }

        #starCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        .alert-toggle {
            position: absolute; top: 20px; right: 20px; cursor: pointer; width: 30px; height: 30px;
            opacity: 0.4; transition: 0.3s; z-index: 100;
        }
        .alert-toggle.active { opacity: 1; }
        .bell-icon {
            width: 20px; height: 20px; border: 2px solid white; border-radius: 10px 10px 2px 2px;
            position: relative; margin: 2px auto;
        }
        .bell-icon::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%);
            width: 6px; height: 4px; background: white; border-radius: 0 0 3px 3px;
        }
        .mute-line {
            position: absolute; top: 50%; left: 50%; width: 34px; height: 2px;
            background: #ff3b30; transform: translate(-50%, -50%) rotate(45deg); display: none;
        }
        .is-muted .mute-line { display: block; }

        #alertOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        @keyframes pulse-red {
            0% { box-shadow: inset 0 0 40px rgba(255, 59, 48, 0); }
            50% { box-shadow: inset 0 0 120px rgba(255, 59, 48, 0.4); }
            100% { box-shadow: inset 0 0 40px rgba(255, 59, 48, 0); }
        }
        .alert-active { animation: pulse-red 2s infinite ease-in-out; }

        /* レイアウトの核となる部分 */
        .app-wrapper { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 20px; 
            width: 100%;
            max-width: 800px;
        }

        .quick-controls { display: flex; flex-direction: column; gap: 12px; }
        .btn-quick {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            color: #888; width: 55px; padding: 10px 0; border-radius: 8px; cursor: pointer; font-size: 11px;
            transition: all 0.2s;
        }
        .btn-quick:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.2); color: #fff; }

        .timer-container {
            position: relative; 
            width: 450px; height: 450px;
            display: flex; align-items: center; justify-content: center;
        }

        #timerCanvas { position: absolute; top: 0; left: 0; z-index: 5; max-width: 100%; height: auto; }

        .timer-info { text-align: center; z-index: 10; pointer-events: none; }
        
        .status-label {
            font-size: 16px; letter-spacing: 5px; height: 24px; margin-bottom: 5px;
            padding-top: 15px; font-weight: 300; color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
        }
        .pulse-text { animation: soft-pulse 2.5s infinite ease-in-out; }
        @keyframes soft-pulse {
            0%, 100% { opacity: 0.2; transform: scale(0.98); }
            50% { opacity: 1; transform: scale(1); }
        }

        .time-main { font-size: 52px; font-weight: bold; line-height: 1; letter-spacing: 2px; }
        .time-sub-m { font-size: 28px; opacity: 0.8; margin-top: 5px; }
        .time-sub-ms { font-size: 18px; opacity: 0.5; font-family: monospace; }

        .bottom-area { margin-top: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; }
        .controls { display: flex; align-items: center; gap: 50px; height: 80px; }
        .btn-start-wrap { text-align: center; width: 65px; cursor: pointer; background: none; border: none; color: white; transition: 0.2s; }
        .btn-start-wrap span { font-size: 32px; display: block; font-weight: 200; }
        .btn-start-wrap label { font-size: 11px; opacity: 0.8; cursor: pointer; letter-spacing: 2px; }

        .btn-pause {
            width: 65px; height: 65px; background-color: #ff3b30; border: none; border-radius: 50%;
            color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 20px rgba(255, 59, 48, 0.4); opacity: 0; transform: scale(0.5); 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); visibility: hidden;
        }
        .btn-pause.show { visibility: visible; opacity: 1; transform: scale(1); }

        .clear-btn {
            background: transparent; border: 1px solid #333; color: #555;
            padding: 8px 60px; border-radius: 10px; cursor: pointer; font-size: 11px; letter-spacing: 2px; transition: 0.3s;
        }

        /* --- スマホ・縦画面向けのレスポンシブ対応 --- */
        @media (max-width: 600px) {
            body { justify-content: flex-start; padding-top: 40px; }
            
            .app-wrapper {
                flex-direction: column; /* 縦並びに変更 */
                gap: 20px;
            }

            .timer-container {
                width: 300px; /* タイマーを小さく */
                height: 300px;
                order: 1;
            }

            #timerCanvas {
                width: 300px;
                height: 300px;
            }

            .time-main { font-size: 36px; }
            .time-sub-m { font-size: 20px; }
            .status-label { font-size: 14px; }

            .quick-controls {
                flex-direction: row; /* ボタンを横に並べる */
                flex-wrap: wrap;     /* 2行になってもOKなように */
                justify-content: center;
                gap: 8px;
                order: 2;
                width: 90%;
            }

            .btn-quick {
                width: 65px;
                padding: 12px 0;
                font-size: 12px;
            }

            .bottom-area {
                order: 3;
                margin-top: 20px;
            }

            .controls {
                gap: 20px;
            }
        }
    </style>
</head>
<body>

    <canvas id="starCanvas"></canvas>

    <div class="alert-toggle active" id="alertToggle" onclick="toggleMute()">
        <div class="bell-icon"></div>
        <div class="mute-line"></div>
    </div>

    <div id="alertOverlay"></div>

    <div class="app-wrapper">
        <div class="quick-controls">
            <button class="btn-quick" onclick="addTime(-1800)">-30m</button>
            <button class="btn-quick" onclick="addTime(-900)">-15m</button>
            <button class="btn-quick" onclick="addTime(-300)">-5m</button>
            <button class="btn-quick" onclick="addTime(-60)">-1m</button>
        </div>

        <div class="timer-container">
            <canvas id="timerCanvas" width="450" height="450"></canvas>
            <div class="timer-info" id="timerInfo">
                <div id="statusLabel" class="status-label"></div>
                <div id="timeMain" class="time-main">00:00</div>
                <div id="timeSubM" class="time-sub-m">00</div>
                <div id="timeSubMs" class="time-sub-ms">00</div>
            </div>
        </div>

        <div class="quick-controls">
            <button class="btn-quick" onclick="addTime(1800)">+30m</button>
            <button class="btn-quick" onclick="addTime(900)">+15m</button>
            <button class="btn-quick" onclick="addTime(300)">+5m</button>
            <button class="btn-quick" onclick="addTime(60)">+1m</button>
        </div>
    </div>

    <div class="bottom-area">
        <div class="controls">
            <button class="btn-start-wrap" onclick="startTimer('minus')">
                <span>ー</span><label>使う</label>
            </button>
            <button id="pauseBtn" class="btn-pause" onclick="pauseTimer()">||</button>
            <button class="btn-start-wrap" onclick="startTimer('plus')">
                <span>＋</span><label>貯める</label>
            </button>
        </div>
        <button class="clear-btn" onclick="clearTime()">CLEAR</button>
    </div>

    <script>
        let actualMs = 0;
        let visualMs = 0;
        let timerId = null;
        let mode = null;
        let lastTimestamp = 0;
        let isMuted = false;
        let lastAnnouncedSec = null;
        let particles = [];
        let rotationAngle = 0;

        const timerCanvas = document.getElementById('timerCanvas');
        const ctx = timerCanvas.getContext('2d');
        const starCanvas = document.getElementById('starCanvas');
        const sctx = starCanvas.getContext('2d');
        const pauseBtn = document.getElementById('pauseBtn');
        const statusLabel = document.getElementById('statusLabel');

        const cyberGradients = [
            ['#00f2ff', '#0066ff'], ['#00d4ff', '#0044ff'], ['#00a2ff', '#0022ff'],
            ['#7000ff', '#4b0082'], ['#b000ff', '#7000ff'], ['#ff00f2', '#b000ff']
        ];

        let stars = [];
        function initStars() {
            starCanvas.width = window.innerWidth; starCanvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 150; i++) {
                stars.push({
                    x: Math.random() * starCanvas.width, y: Math.random() * starCanvas.height,
                    size: Math.random() * 1.5, vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2, opacity: Math.random()
                });
            }
        }
        window.addEventListener('resize', initStars); initStars();

        function drawStars() {
            sctx.clearRect(0, 0, starCanvas.width, starCanvas.height);
            stars.forEach(s => {
                s.x += s.vx; s.y += s.vy;
                if (s.x < 0) s.x = starCanvas.width; if (s.x > starCanvas.width) s.x = 0;
                if (s.y < 0) s.y = starCanvas.height; if (s.y > starCanvas.height) s.y = 0;
                sctx.beginPath(); sctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                sctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`; sctx.fill();
            });
        }

        class Particle {
            constructor(type) {
                this.type = type;
                this.cx = timerCanvas.width / 2; this.cy = timerCanvas.height / 2;
                this.color = '#ffffff';
                if (type === 'in') {
                    this.angle = Math.random() * Math.PI * 2;
                    this.radius = 220 + Math.random() * 50;
                    this.speed = 0.005 + Math.random() * 0.01;
                    this.radialSpeed = 0.8 + Math.random() * 0.5;
                } else {
                    this.angle = Math.random() * Math.PI * 2;
                    this.radius = Math.random() * 20;
                    this.speed = (Math.random() - 0.5) * 0.02;
                    this.radialSpeed = 1.2 + Math.random() * 2; 
                }
                this.size = Math.random() * 1.8 + 0.5;
                this.life = 1.0;
            }
            update() {
                if (this.type === 'in') {
                    this.angle += this.speed; this.radius -= this.radialSpeed;
                    this.life = Math.min(1.0, (this.radius - 40) / 100);
                } else {
                    this.angle += this.speed; this.radius += this.radialSpeed;
                    this.life = (this.radius < 50) ? 0.2 : 1.0 - (this.radius / 250);
                }
                this.x = this.cx + Math.cos(this.angle) * this.radius;
                this.y = this.cy + Math.sin(this.angle) * this.radius;
                return this.life > 0.01 && this.radius < 300 && (this.type === 'in' ? this.radius > 30 : true);
            }
            draw() {
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color; ctx.globalAlpha = this.life * 0.5;
                ctx.fill(); ctx.globalAlpha = 1.0;
            }
        }

        function startTimer(newMode) {
            if (timerId) cancelAnimationFrame(timerId);
            mode = newMode;
            statusLabel.innerText = (mode === 'plus') ? "チャージ中" : "使用中";
            statusLabel.classList.add('pulse-text');
            pauseBtn.classList.add('show');
            lastTimestamp = performance.now();
            const tick = (now) => {
                const delta = now - lastTimestamp; lastTimestamp = now;
                actualMs += (mode === 'plus' ? delta : -delta);
                if (mode === 'plus' && Math.random() > 0.3) particles.push(new Particle('in'));
                else if (mode === 'minus' && Math.random() > 0.35) particles.push(new Particle('out'));
                checkCountdown(); timerId = requestAnimationFrame(tick);
            };
            timerId = requestAnimationFrame(tick);
        }

        function toggleMute() { isMuted = !isMuted; document.getElementById('alertToggle').classList.toggle('is-muted', isMuted); }
        function speak(text) { if (!isMuted) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; window.speechSynthesis.speak(u); } }

        function checkCountdown() {
            const currentSec = Math.floor(actualMs / 1000);
            if (mode === 'minus' && currentSec !== lastAnnouncedSec) {
                if ([600, 300, 60, 0].includes(currentSec)) speak(currentSec === 0 ? "Time over" : currentSec/60 + " minutes left");
                lastAnnouncedSec = currentSec;
            }
        }

        function pauseTimer() {
            cancelAnimationFrame(timerId); timerId = null; mode = null;
            statusLabel.innerText = ""; statusLabel.classList.remove('pulse-text'); pauseBtn.classList.remove('show');
        }

        function clearTime() { pauseTimer(); actualMs = 0; visualMs = 0; lastAnnouncedSec = null; }

        function addTime(amount) {
            actualMs += amount * 1000;
            for(let i=0; i<15; i++) particles.push(new Particle(amount > 0 ? 'in' : 'out'));
        }

        function animate() {
            visualMs += (actualMs - visualMs) * 0.15;
            if (mode === 'plus') rotationAngle += 0.008;
            else if (mode === 'minus') rotationAngle -= 0.015;
            else rotationAngle += 0.002;
            drawStars(); updateUI(); drawTimer(); requestAnimationFrame(animate);
        }

        function updateUI() {
            const absMs = Math.abs(Math.round(visualMs));
            const h = Math.floor(absMs / 3600000); const m = Math.floor((absMs % 3600000) / 60000);
            const s = Math.floor((absMs % 60000) / 1000); const ms = Math.floor((absMs % 1000) / 10);
            document.getElementById('timeMain').innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            document.getElementById('timeSubM').innerText = String(s).padStart(2, '0');
            document.getElementById('timeSubMs').innerText = String(ms).padStart(2, '0');
            const isNegative = actualMs < 0;
            document.getElementById('alertOverlay').classList.toggle('alert-active', isNegative);
            document.querySelectorAll('.time-main, .time-sub-m').forEach(el => el.style.color = isNegative ? '#ff3b30' : 'white');
        }

        function drawTimer() {
            ctx.clearRect(0, 0, timerCanvas.width, timerCanvas.height);
            let cx = timerCanvas.width / 2, cy = timerCanvas.height / 2;
            const time = performance.now();
            
            const pulseRate = (mode === 'minus') ? 250 : 800;
            const pulse = (Math.sin(time / pulseRate) + 1) / 2;
            
            const totalRings = 6;
            for (let i = 0; i < totalRings; i++) {
                ctx.beginPath(); ctx.arc(cx, cy, 125 + (i * 18), 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 255, 255, 0.03)`; ctx.stroke();
            }

            const totalSeconds = visualMs / 1000;
            const absSec = Math.abs(totalSeconds);
            const activeGradients = (totalSeconds >= 0) ? cyberGradients : [['#FF4D4D', '#B30000']];

            for (let i = 0; i < totalRings; i++) {
                const radius = 125 + (i * 18);
                const hourInSec = 3600;
                let progress = Math.max(0, Math.min(1, (absSec - i * hourInSec) / hourInSec));
                if (progress > 0) {
                    ctx.save(); ctx.translate(cx, cy); ctx.rotate(rotationAngle * (1 + i * 0.15));
                    ctx.beginPath(); ctx.arc(0, 0, radius, 0, Math.PI * 2 * progress);
                    
                    const baseWidth = (mode === 'minus') ? 4.0 : 3.0;
                    const widthVariation = pulse * (mode === 'minus' ? 3.0 : 2.0);
                    ctx.lineWidth = baseWidth + widthVariation;
                    
                    ctx.shadowBlur = (mode === 'minus' ? 12 : 8) + (pulse * 12);
                    ctx.shadowColor = activeGradients[i % activeGradients.length][0];
                    ctx.strokeStyle = activeGradients[i % activeGradients.length][0];
                    
                    ctx.lineCap = 'round';
                    ctx.stroke(); ctx.restore();
                }
            }
            particles = particles.filter(p => { if (p.update()) { p.draw(); return true; } return false; });
        }
        animate();
    </script>
</body>
</html>
