<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Time Bank - Supernova Evolution</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --accent-color: #00f2ff;
            --supernova-glow: 0 0 20px rgba(0, 242, 255, 0.5);
            --gold-gradient: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }

        body {
            background: radial-gradient(circle at center, #0a0a1a 0%, #020205 100%);
            color: white;
            font-family: 'Inter', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; overflow-x: hidden; user-select: none;
            touch-action: manipulation;
            padding-top: var(--safe-top);
            box-sizing: border-box;
            transition: background 1.5s ease;
        }

        body.supernova-active {
            background: radial-gradient(circle at center, #2b1d00 0%, #0a0700 70%, #000000 100%);
        }

        #starCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        header {
            position: absolute; top: var(--safe-top); width: 100%;
            display: flex; align-items: center; justify-content: center; height: 60px; z-index: 100;
        }

        .logo-text {
            font-size: 24px; font-weight: 900; letter-spacing: 4px; color: #ffffff;
            text-transform: uppercase;
            text-shadow: var(--supernova-glow);
            display: flex; align-items: center;
        }
        .logo-text span { color: var(--accent-color); margin-right: 4px; }

        .menu-trigger {
            position: absolute; left: 20px; cursor: pointer;
            width: 30px; height: 30px; display: flex; flex-direction: column; justify-content: center; gap: 6px;
        }
        .menu-trigger span { width: 100%; height: 2px; background: white; transition: 0.3s; }
        
        .side-menu {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: rgba(10, 10, 26, 0.95); backdrop-filter: blur(15px);
            z-index: 200; transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            padding: 80px 30px; box-sizing: border-box; border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }
        .side-menu.open { left: 0; box-shadow: 20px 0 50px rgba(0,0,0,0.5); }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 150; }
        
        .menu-section { margin-bottom: 30px; }
        .menu-section h3 { font-size: 11px; color: var(--accent-color); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; opacity: 0.8; }
        .menu-item { color: #888; text-decoration: none; display: block; padding: 10px 0; font-size: 15px; cursor: pointer; transition: 0.3s; }
        .menu-item.active { color: white; font-weight: bold; }
        .desc-text { font-size: 13px; line-height: 1.6; color: #aaa; white-space: pre-wrap; }
        .desc-highlight { color: #fff; font-weight: bold; display: block; margin-bottom: 8px; font-size: 15px; }

        .support-box { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .btn-support-link { 
            background: var(--gold-gradient); color: #000; border: none; width: 100%; padding: 12px 10px; 
            border-radius: 30px; font-weight: bold; font-size: 13px; cursor: pointer; 
            margin-bottom: 15px; transition: 0.3s; text-decoration: none; display: block; text-align: center;
            box-sizing: border-box; 
            line-height: 1.4; overflow: hidden; 
        }
        .btn-support-link:active { transform: scale(0.95); opacity: 0.9; }
        .support-msg { font-size: 12px; color: #ccc; line-height: 1.5; text-align: left; }
        .support-msg b { color: #fff; border-bottom: 1px solid var(--accent-color); }

        .pass-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); 
            color: white; padding: 10px; border-radius: 8px; box-sizing: border-box; margin-bottom: 10px; outline: none;
        }
        .pass-input:focus { border-color: var(--accent-color); }
        
        .auth-btns { display: flex; gap: 8px; }
        .btn-auth { background: var(--accent-color); color: #000; border: none; flex: 2; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-reset-mode { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); flex: 1.5; padding: 10px; border-radius: 8px; font-size: 10px; cursor: pointer; transition: 0.3s; display: none; }
        .btn-reset-mode.show { display: block; }

        /* Share Styles */
        .share-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 5px; }
        .share-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            aspect-ratio: 1/1; border-radius: 10px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s; text-decoration: none;
        }
        .share-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.15); }
        .share-btn svg { width: 20px; height: 20px; fill: white; opacity: 0.8; }
        .share-btn.copy svg { fill: var(--accent-color); }

        .custom-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: rgba(10, 10, 26, 0.98);
            width: 85%; max-width: 420px; padding: 30px;
            border-radius: 20px; border: 2px solid var(--accent-color);
            text-align: center; 
            box-shadow: 0 0 50px rgba(0, 0, 0, 1), 0 0 30px rgba(var(--accent-rgb, 0, 242, 255), 0.3);
            max-height: 85vh; overflow-y: auto;
            box-sizing: border-box;
        }

        .modal-step { margin-bottom: 25px; text-align: center; }
        .step-num { color: var(--accent-color); font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px; letter-spacing: 2px; }
        .step-title { font-size: 18px; font-weight: bold; display: block; margin-bottom: 8px; text-shadow: 0 0 10px var(--accent-color); }
        .step-desc { font-size: 13px; color: #ccc; line-height: 1.5; }
        
        .close-btn { 
            background: transparent; color: var(--accent-color); border: 2px solid var(--accent-color); 
            padding: 12px 50px; border-radius: 30px; font-weight: bold; cursor: pointer; 
            margin-top: 10px; transition: 0.3s; text-transform: uppercase; letter-spacing: 2px;
        }
        .close-btn:active { background: var(--accent-color); color: #000; transform: scale(0.9); }

        .alert-toggle { position: absolute; top: 15px; right: 20px; cursor: pointer; width: 30px; height: 30px; opacity: 0.4; transition: 0.3s; z-index: 100; }
        .alert-toggle.active { opacity: 1; }
        .bell-icon { width: 20px; height: 20px; border: 2px solid white; border-radius: 10px 10px 2px 2px; position: relative; margin: 2px auto; }
        .bell-icon::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 6px; height: 4px; background: white; border-radius: 0 0 3px 3px; }
        .mute-line { position: absolute; top: 50%; left: 50%; width: 34px; height: 2px; background: #ff3b30; transform: translate(-50%, -50%) rotate(45deg); display: none; }
        .is-muted .mute-line { display: block; }

        #alertOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        @keyframes pulse-red {
            0% { box-shadow: inset 0 0 40px rgba(255, 59, 48, 0); }
            50% { box-shadow: inset 0 0 120px rgba(255, 59, 48, 0.4); }
            100% { box-shadow: inset 0 0 40px rgba(255, 59, 48, 0); }
        }
        .alert-active { animation: pulse-red 2s infinite ease-in-out; }

        .app-wrapper { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; max-width: 900px; margin-top: 40px; }
        .quick-controls { display: flex; flex-direction: column; gap: 12px; }
        .btn-quick { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #888; width: 55px; padding: 10px 0; border-radius: 8px; cursor: pointer; font-size: 11px; transition: all 0.2s; touch-action: manipulation; }
        .btn-quick:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.2); color: #fff; }

        .timer-container { position: relative; width: 500px; height: 500px; display: flex; align-items: center; justify-content: center; }
        #timerCanvas { position: absolute; top: 0; left: 0; z-index: 5; width: 100%; height: 100%; }
        .timer-info { text-align: center; z-index: 10; pointer-events: none; margin-top: -10px; }
        .status-label { font-size: 16px; letter-spacing: 2px; height: 24px; margin-bottom: 5px; padding-top: 15px; font-weight: bold; color: white; }
        .pulse-text { animation: soft-pulse 2.5s infinite ease-in-out; }
        @keyframes soft-pulse { 0%, 100% { opacity: 0.2; transform: scale(0.98); } 50% { opacity: 1; transform: scale(1); } }
        .time-main { font-size: 52px; font-weight: bold; line-height: 1; letter-spacing: 2px; transition: text-shadow 0.5s ease; }
        .time-sub-m { font-size: 28px; opacity: 0.8; margin-top: 5px; }
        .time-sub-ms { font-size: 18px; opacity: 0.5; font-family: monospace; }

        .bottom-area { margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .controls { display: flex; align-items: center; gap: 50px; height: 80px; }
        .btn-start-wrap { text-align: center; width: 75px; cursor: pointer; background: none; border: none; color: white; transition: 0.2s; touch-action: manipulation; }
        .btn-start-wrap span { font-size: 32px; display: block; font-weight: 200; }
        .btn-start-wrap label { font-size: 11px; opacity: 0.8; cursor: pointer; letter-spacing: 1px; display: block; }
        .btn-pause { width: 65px; height: 65px; background-color: #ff3b30; border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(255, 59, 48, 0.4); opacity: 0; transform: scale(0.5); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); visibility: hidden; touch-action: manipulation; }
        .btn-pause.show { visibility: visible; opacity: 1; transform: scale(1); }
        .clear-btn { background: transparent; border: 1px solid #333; color: #555; padding: 8px 60px; border-radius: 10px; cursor: pointer; font-size: 11px; letter-spacing: 2px; transition: 0.3s; touch-action: manipulation; }

        @media (max-width: 600px) {
            body { justify-content: flex-start; }
            header { height: 50px; }
            .logo-text { font-size: 18px; letter-spacing: 3px; }
            .app-wrapper { flex-direction: column; gap: 10px; margin-top: 60px; }
            .timer-container { width: 350px; height: 350px; order: 1; }
            .time-main { font-size: 36px; }
            .quick-controls { flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 8px; order: 2; width: 95%; }
            .btn-quick { width: 70px; padding: 12px 0; font-size: 12px; }
            .bottom-area { order: 3; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <canvas id="starCanvas"></canvas>

    <header>
        <div class="menu-trigger" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </div>
        <div class="logo-text">TIME<span>BANK</span></div>
        <div class="alert-toggle active" id="alertToggle" onclick="toggleMute()">
            <div class="bell-icon"></div>
            <div class="mute-line"></div>
        </div>
    </header>

    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        
        <div class="menu-section">
            <h3 id="devHeader">DEVELOPMENT</h3>
            <div id="devDesc" class="desc-text"></div>
        </div>

        <div class="menu-section">
            <h3 id="langHeader">Language</h3>
            <div id="btnJp" class="menu-item active" onclick="setLanguage('ja')">æ—¥æœ¬èª</div>
            <div id="btnEn" class="menu-item" onclick="setLanguage('en')">English</div>
        </div>

        <div class="menu-section">
            <h3 id="howToHeader">GUIDE</h3>
            <div id="btnGuide" class="menu-item" onclick="showHowTo()">ä½¿ã„æ–¹ã‚’è¦‹ã‚‹</div>
        </div>

        <div class="menu-section">
            <h3 id="parentsHeader">FOR PARENTS</h3>
            <div id="btnParents" class="menu-item" onclick="showParentsModal()">ä¿è­·è€…ã®æ–¹ã¸</div>
        </div>

        <div class="menu-section">
            <h3 id="supportHeader">SUPPORT US</h3>
            <div class="support-box">
                <a href="https://timebank.base.shop/items/130844239" target="_blank" class="btn-support-link" id="btnSupportText">TimeBankã‚’100å††ã§å¿œæ´ã™ã‚‹(BASEã‚µã‚¤ãƒˆ)</a>
                <div class="support-msg" id="supportMsgText"></div>
            </div>
        </div>

        <div class="menu-section">
            <h3 id="codeHeader">SUPPORT CODE</h3>
            <div id="codeDesc" style="font-size: 11px; margin-bottom: 10px; color: #888; line-height: 1.4;"></div>
            <input type="text" id="passInput" class="pass-input" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›">
            <div class="auth-btns">
                <button class="btn-auth" onclick="checkPass()">èªè¨¼</button>
                <button id="resetModeBtn" class="btn-reset-mode" onclick="deactivateSupernovaMode(true)">é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</button>
            </div>
            <div id="supporterMsg" style="font-size: 11px; margin-top: 8px; color: var(--accent-color); line-height: 1.4;"></div>
        </div>

        <div class="menu-section">
            <h3 id="shareHeader">SHARE</h3>
            <div class="share-grid">
                <a id="shareX" href="#" target="_blank" class="share-btn" title="X">
                    <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                </a>
                <a id="shareLine" href="#" target="_blank" class="share-btn" title="LINE">
                    <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 5.45 2 9.68c0 2.2 1.24 4.17 3.23 5.48-.16.53-.58 1.93-.66 2.22-.1.35.14.35.3.23.12-.09 1.94-1.32 2.7-1.84.45.13.93.2 1.43.2 5.52 0 10-3.45 10-7.68S17.52 2 12 2z"/></svg>
                </a>
                <a id="shareFb" href="#" target="_blank" class="share-btn" title="Facebook">
                    <svg viewBox="0 0 24 24"><path d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.99 3.66 9.12 8.44 9.88v-6.99H7.9v-2.89h2.54V9.85c0-2.51 1.49-3.89 3.77-3.89 1.09 0 2.23.19 2.23.19v2.46h-1.26c-1.24 0-1.63.77-1.63 1.56v1.88h2.77l-.44 2.89h-2.33v6.99C18.34 21.12 22 16.99 22 12z"/></svg>
                </a>
                <div class="share-btn copy" onclick="copyLink()" title="Copy Link">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                </div>
            </div>
        </div>
    </div>

    <div id="howToModal" class="custom-modal">
        <div class="modal-content" id="howToContent"></div>
    </div>

    <div id="parentsModal" class="custom-modal">
        <div class="modal-content" style="text-align: left;">
            <div id="parentsContent"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="close-btn" onclick="closeParentsModal()">CLOSE</button>
            </div>
        </div>
    </div>

    <div id="alertOverlay"></div>

    <div class="app-wrapper">
        <div class="quick-controls">
            <button class="btn-quick" onclick="addTime(-1800)">-30m</button>
            <button class="btn-quick" onclick="addTime(-900)">-15m</button>
            <button class="btn-quick" onclick="addTime(-300)">-5m</button>
            <button class="btn-quick" onclick="addTime(-60)">-1m</button>
        </div>

        <div class="timer-container">
            <canvas id="timerCanvas" width="500" height="500"></canvas>
            <div class="timer-info" id="timerInfo">
                <div id="statusLabel" class="status-label"></div>
                <div id="timeMain" class="time-main">00:00</div>
                <div id="timeSubM" class="time-sub-m">00</div>
                <div id="timeSubMs" class="time-sub-ms">00</div>
            </div>
        </div>

        <div class="quick-controls">
            <button class="btn-quick" onclick="addTime(1800)">+30m</button>
            <button class="btn-quick" onclick="addTime(900)">+15m</button>
            <button class="btn-quick" onclick="addTime(300)">+5m</button>
            <button class="btn-quick" onclick="addTime(60)">+1m</button>
        </div>
    </div>

    <div class="bottom-area">
        <div class="controls">
            <button class="btn-start-wrap" onclick="startTimer('minus')">
                <span>ãƒ¼</span><label id="labelUse">ä½¿ã†</label>
            </button>
            <button id="pauseBtn" class="btn-pause" onclick="pauseTimer()">||</button>
            <button class="btn-start-wrap" onclick="startTimer('plus')">
                <span>ï¼‹</span><label id="labelCharge">è²¯ã‚ã‚‹</label>
            </button>
        </div>
        <button id="resetBtn" class="clear-btn" onclick="clearTime()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <script>
        const PASS_CODE = "chucktheworld"; 
        let isSupernovaMode = false;
        let shootingStarProbability = 1 / (60 * 30);

        function openSupportLink() {
            const url = "https://chucky.base.shop/items/94917462";
            if (url) {
                window.open(url, '_blank');
            } else {
                alert(currentLang === 'ja' ? "å¿œæ´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ç¾åœ¨URLã‚’æº–å‚™ä¸­ã§ã™ã€‚" : "Thank you for your support! Link is coming soon.");
            }
        }

        if ("Notification" in window) {
            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        function sendNotification(title, body) {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(title, { body: body });
            }
        }

        const translations = {
            ja: {
                use: "ä½¿ã†", charge: "è²¯ã‚ã‚‹", reset: "ãƒªã‚»ãƒƒãƒˆ", using: "ä½¿ç”¨ä¸­", charging: "ãƒãƒ£ãƒ¼ã‚¸ä¸­", shortage: "æ™‚é–“ãŒè¶³ã‚Šã¾ã›ã‚“",
                voiceUse: "æ™‚é–“ã‚’ä½¿ç”¨ã—ã¾ã™", voiceCharge: "æ™‚é–“ã‚’ãƒãƒ£ãƒ¼ã‚¸ã—ã¾ã™",
                devHeader: "DEVELOPMENT", guideBtn: "ä½¿ã„æ–¹ã‚’è¦‹ã‚‹", parentsHeader: "FOR PARENTS", parentsBtn: "ä¿è­·è€…ã®æ–¹ã¸",
                supportBtn: "TimeBankã‚’100å††ã§å¿œæ´ã™ã‚‹(BASEã‚µã‚¤ãƒˆ)",
                supportMsg: `ã“ã®ã‚¢ãƒ—ãƒªã¯<b>ç„¡æ–™ã§ä½¿ãˆã¾ã™ã€‚</b><br><br>å½¹ã«ç«‹ã¤ã‚‚ã®ã‚’ä½œã£ã¦å¿œæ´ã—ã¦ã‚‚ã‚‰ãˆã‚‹å–œã³ã‚’ã€æˆ‘ãŒå­ã«æ•™è‚²ã¨ã—ã¦æ„Ÿã˜ã¦ã‚‚ã‚‰ãˆãŸã‚‰å¬‰ã—ã„ã®ã§ã€Œã„ã„ãªã€ã€Œå½¹ã«ç«‹ã£ãŸãªã€ã¨æ€ã£ãŸã‚‰å¿œæ´ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚ä»Šå¾Œã‚‚ã„ã‚ã„ã‚ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å‡ºã—åˆã£ã¦æ”¹å–„ã—ã¦ã„ãäºˆå®šã§ã™ï¼`,
                codeDesc: "TimeBankã‚’100å††ã§å¿œæ´ã™ã‚‹ã¨è‰²ã‚„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒå¤‰ã‚ã‚‹ç‰¹åˆ¥ãƒ¢ãƒ¼ãƒ‰ãŒä½¿ãˆã¾ã™ã€‚",
                devDesc: "<span class='desc-highlight'>ã€Œå…¨åŠ›ã§å­¦ã³ã€å…¨åŠ›ã§éŠã¼ã†ã€</span>Time Bankã¯ã€å­ã©ã‚‚ãŸã¡ã®æ™‚é–“ã‚’ã€Œè²¯ã‚ã‚‹ã€ã€Œä½¿ã†ã€ã¨ã„ã†æ¦‚å¿µã§è¦–è¦šåŒ–ã—ã€æ—¥ã€…ã®æ´»å‹•ã‚’ã‚²ãƒ¼ãƒ ã®ã‚ˆã†ã«ç®¡ç†ãƒ»æ”¹å–„ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚",
                guideContent: `
                    <div class="modal-step"><span class="step-num">MISSION 01</span><span class="step-title">ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è²¯ã‚ã‚‹</span><p class="step-desc">å‹‰å¼·ã‚„èª­æ›¸ã‚’ã™ã‚‹ã¨ãã¯ã€Œï¼‹è²¯ã‚ã‚‹ã€ã‚’èµ·å‹•ã€‚æœªæ¥ã®éŠã³ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è“„ãˆã‚ˆã†ã€‚</p></div>
                    <div class="modal-step"><span class="step-num">MISSION 02</span><span class="step-title">ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è§£æ”¾</span><p class="step-desc">éŠã³ã®æ™‚é–“ã¯ã€Œãƒ¼ä½¿ã†ã€ã‚’èµ·å‹•ã€‚è²¯ã‚ãŸåˆ†ã ã‘ã€å…¨åŠ›ã§æ¥½ã—ã‚€ã®ãŒå®‡å®™ã®ãƒ«ãƒ¼ãƒ«ã ï¼</p></div>
                    <div class="modal-step"><span class="step-num">MISSION 03</span><span class="step-title">ãŠã™ã™ã‚ã®è¨­å®š</span><p class="step-desc">iPhoneã®æ–¹ã¯Safariã§é–‹ãã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’ã™ã‚‹ã¨ã€æœ¬ç‰©ã®ã‚¢ãƒ—ãƒªã®ã‚ˆã†ã«å…¨ç”»é¢ã§å¿«é©ã«ä½¿ãˆã¾ã™ã€‚</p></div>
                    <div class="modal-step"><span class="step-num">GOLDEN RATIO</span><span class="step-title">ã€Œ1ï¼š1ã€ã®å‡è¡¡</span><p class="step-desc">å­¦ã¶æ™‚é–“ã¨éŠã¶æ™‚é–“ã‚’åŒã˜ã«ã™ã‚‹ã€‚ã“ã‚ŒãŒæœ€å¼·ã®ã‚¿ã‚¤ãƒ ãƒã‚¹ã‚¿ãƒ¼ã¸ã®é“ã€‚</p></div>
                    <button class="close-btn" onclick="closeHowTo()">CLOSE</button>`,
                parentsBody: `
                    <h2 style="color:var(--accent-color); font-size:20px; margin-bottom:20px; text-align:center;">åˆ¶ä½œã®æƒ³ã„</h2>
                    <p style="font-size:13px; line-height:1.6; color:#ccc; margin-bottom:20px;">
                        ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã€Œå­ã©ã‚‚ã«ã‚²ãƒ¼ãƒ ã‚’æ€ã„åˆ‡ã‚Šæ¥½ã—ã‚“ã§ã»ã—ã„ã€ã§ã‚‚ãƒãƒ©ãƒ³ã‚¹ã‚‚å¤§åˆ‡ã«ã—ã¦ã»ã—ã„ã€ã¨ã„ã†æ€ã„ã‹ã‚‰ç”Ÿã¾ã‚Œã¾ã—ãŸã€‚<br><br>
                        Time Bankã¯ã€æ™‚é–“ã‚’ã€Œè²¯ã‚ã‚‹ã€ã¨ã€Œä½¿ã†ã€ã¨ã„ã†ã‚·ãƒ³ãƒ—ãƒ«ãªä»•çµ„ã¿ã§è¦–è¦šåŒ–ã—ã€å­ã©ã‚‚è‡ªèº«ãŒè‡ªå¾‹çš„ã«æ¥½ã—ã¿ãªãŒã‚‰å‹•ããã£ã‹ã‘ã‚’ä½œã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
                    </p>
                    <h3 style="color:var(--accent-color); font-size:16px; margin-bottom:10px;">ğŸ¤– è¦ªå­ã¨AIã®å…±åŒé–‹ç™º</h3>
                    <p style="font-size:13px; line-height:1.6; color:#ccc; margin-bottom:20px;">
                        ã“ã®ã‚¢ãƒ—ãƒªã¯ã€å­ã©ã‚‚ã¨ä¸€ç·’ã«ã€Œã©ã‚“ãªæ©Ÿèƒ½ãŒæ¬²ã—ã„ã‹ã€ã€Œã©ã‚“ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚„ä»•æ›ã‘ãŒãƒ¯ã‚¯ãƒ¯ã‚¯ã™ã‚‹ã‹ã€ã‚’è©±ã—åˆã„ãªãŒã‚‰ã€AIï¼ˆäººå·¥çŸ¥èƒ½ï¼‰ã‚’é§†ä½¿ã—ã¦1ã‹ã‚‰ä½œæˆã—ã¾ã—ãŸã€‚è¦ªå­ã§è©¦è¡ŒéŒ¯èª¤ã—ã¦ä½œã‚Šä¸Šã’ãŸã€ä¸–ç•Œã«ã²ã¨ã¤ã ã‘ã®ã‚¿ã‚¤ãƒ ãƒã‚·ãƒ³ã§ã™ã€‚
                    </p>
                    <h3 style="color:var(--accent-color); font-size:16px; margin-bottom:10px;">ğŸ’¡ åŠ¹æœçš„ãªä½¿ã„æ–¹ã®ãƒ’ãƒ³ãƒˆ</h3>
                    <div style="font-size:13px; line-height:1.6; color:#ccc;">
                        <b style="color:#fff;">1. ã€Œ1:1ã®æ³•å‰‡ã€ã‹ã‚‰å§‹ã‚ã‚‹</b><br>
                        ã€Œ30åˆ†å‹‰å¼·ã—ãŸã‚‰30åˆ†éŠã¹ã‚‹ã€ã¨ã„ã†ã‚·ãƒ³ãƒ—ãƒ«ãªæ¯”ç‡ã€‚ç­‰ä¾¡äº¤æ›ã®æ„Ÿè¦šãŒã‚¿ã‚¤ãƒ ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã®åŸºç¤ã‚’ä½œã‚Šã¾ã™ã€‚<br><br>
                        <b style="color:#fff;">2. ã€Œå‰å€Ÿã‚Šã€ã‚’è¨±å®¹ã™ã‚‹</b><br>
                        æ™‚é–“ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã£ã¦ã‚‚OKã€‚ã€Œæœªæ¥ã®è‡ªåˆ†ã¸ã®å€Ÿé‡‘ã€ã¨ã—ã¦ã€å¾Œã§ç©´åŸ‹ã‚ã™ã‚‹è²¬ä»»æ„Ÿã‚’è‚²ã¦ã¾ã™ã€‚<br><br>
                        <b style="color:#fff;">3. æˆæœã‚’ä¸€ç·’ã«å–œã¶</b><br>
                        èª­æ›¸ã‚„å‹‰å¼·ã‚’ã—ã¦æ™‚é–“ãŒå°‘ã—ã§ã‚‚æºœã¾ã£ãŸã‚‰ã€ä¸€ç·’ã«å–œã³ã‚’åˆ†ã‹ã¡åˆã„ã¾ã—ã‚‡ã†ï¼
                    </div>`,
                timeOver: "æ™‚é–“çµ‚äº†", timeOverMsg: "æ™‚é–“ãŒãªããªã‚Šã¾ã—ãŸï¼", left: "æ®‹ã‚Š", minutes: "åˆ†ã§ã™", voiceLang: "ja-JP",
                supporterOk: "âœ¨ SUPERNOVAãƒ¢ãƒ¼ãƒ‰èµ·å‹•ï¼ âœ¨<br>å¿œæ´ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼",
                backNormal: "é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹", passPlaceholder: "åˆè¨€è‘‰ã‚’å…¥åŠ›", authBtn: "èªè¨¼",
                shareTitle: "TIME BANK | å­ã©ã‚‚ã®è‡ªå¾‹ã‚’è‚²ã¦ã‚‹ã‚¿ã‚¤ãƒ ãƒã‚·ãƒ³"
            },
            en: {
                use: "USE", charge: "CHARGE", reset: "RESET", using: "USING", charging: "CHARGING", shortage: "TIME SHORTAGE",
                voiceUse: "Starting to use time", voiceCharge: "Starting to charge time",
                devHeader: "DEVELOPMENT", guideBtn: "GUIDE", parentsHeader: "FOR PARENTS", parentsBtn: "For Parents",
                supportBtn: "Support TimeBank ($1 via BASE)",
                supportMsg: `This app is <b>free to use.</b><br><br>We want our child to experience the joy of creating something useful and being supported as part of their education. If you think "this is great" or "this was helpful," we would be very happy to have your support! We plan to continue improving the app by brainstorming many more ideas together!`,
                codeDesc: "By supporting TimeBank, you can unlock a Special Mode with unique colors and animations.",
                devDesc: "<span class='desc-highlight'>\"Learn Hard, Play Hard\"</span>Time Bank visualizes time as 'saving' and 'spending,' helping children manage their daily activities like a game.",
                guideContent: `
                    <div class="modal-step"><span class="step-num">MISSION 01</span><span class="step-title">CHARGE ENERGY</span><p class="step-desc">When studying or reading, start "CHARGE". Store up energy for your future play time!</p></div>
                    <div class="modal-step"><span class="step-num">MISSION 02</span><span class="step-title">RELEASE ENERGY</span><p class="step-desc">When it's play time, start "USE". Using only what you've saved is the rule of the universe!</p></div>
                    <div class="modal-step"><span class="step-num">MISSION 03</span><span class="step-title">BEST SETUP</span><p class="step-desc">iPhone users: Open in Safari and "Add to Home Screen" to use it as a full-screen app.</p></div>
                    <div class="modal-step"><span class="step-num">GOLDEN RATIO</span><span class="step-title">EQUILIBRIUM 1:1</span><p class="step-desc">Balance learning and playing equally. This is the path to becoming a True Time Master.</p></div>
                    <button class="close-btn" onclick="closeHowTo()">CLOSE</button>`,
                parentsBody: `
                    <h2 style="color:var(--accent-color); font-size:20px; margin-bottom:20px; text-align:center;">Our Philosophy</h2>
                    <p style="font-size:13px; line-height:1.6; color:#ccc; margin-bottom:20px;">
                        This app was born from a desire for our child to fully enjoy gaming while also valuing balance in life.<br><br>
                        Time Bank visualizes time through the simple mechanism of "Saving" and "Spending," creating a trigger for children to move autonomously and enjoyably.
                    </p>
                    <h3 style="color:var(--accent-color); font-size:16px; margin-bottom:10px;">ğŸ¤– Parent-Child & AI Co-development</h3>
                    <p style="font-size:13px; line-height:1.6; color:#ccc; margin-bottom:20px;">
                        We developed this app from scratch using AI, discussing what features and designs would be most exciting. It is a unique "Time Machine" built through parent-child trial and error.
                    </p>
                    <h3 style="color:var(--accent-color); font-size:16px; margin-bottom:10px;">ğŸ’¡ Tips for Effective Use</h3>
                    <div style="font-size:13px; line-height:1.6; color:#ccc;">
                        <b style="color:#fff;">1. Start with the "1:1 Rule"</b><br>
                        A simple ratio: "Study for 30 min, play for 30 min." This sense of equal exchange builds the foundation of time management.<br><br>
                        <b style="color:#fff;">2. Allow "Borrowing"</b><br>
                        It's okay if time goes negative. Treat it as "debt to their future self" to foster a sense of responsibility for making it up later.<br><br>
                        <b style="color:#fff;">3. Celebrate Success Together</b><br>
                        When they save even a little time through reading or studying, share that joy together!
                    </div>`,
                timeOver: "Time over", timeOverMsg: "Time is up!", left: "", minutes: "minutes left", voiceLang: "en-US",
                supporterOk: "âœ¨ Special Mode Activated! âœ¨<br>Thank you for your support!",
                backNormal: "Back to Normal", passPlaceholder: "Enter Code", authBtn: "Auth",
                shareTitle: "TIME BANK | Time management app for kids"
            }
        };

        let currentLang = 'ja';
        function setLanguage(lang) {
            currentLang = lang;
            const t = translations[lang];
            document.getElementById('labelUse').innerText = t.use;
            document.getElementById('labelCharge').innerText = t.charge;
            document.getElementById('resetBtn').innerText = t.reset;
            document.getElementById('devHeader').innerText = t.devHeader;
            document.getElementById('devDesc').innerHTML = t.devDesc;
            document.getElementById('btnGuide').innerText = t.guideBtn;
            document.getElementById('parentsHeader').innerText = t.parentsHeader;
            document.getElementById('btnParents').innerText = t.parentsBtn;
            document.getElementById('parentsContent').innerHTML = t.parentsBody;
            document.getElementById('howToContent').innerHTML = t.guideContent;
            document.getElementById('resetModeBtn').innerText = t.backNormal;
            document.getElementById('btnSupportText').innerText = t.supportBtn;
            document.getElementById('supportMsgText').innerHTML = t.supportMsg;
            document.getElementById('codeDesc').innerText = t.codeDesc;
            document.getElementById('passInput').placeholder = t.passPlaceholder;
            document.querySelector('.btn-auth').innerText = t.authBtn;
            
            document.getElementById('btnJp').classList.toggle('active', lang === 'ja');
            document.getElementById('btnEn').classList.toggle('active', lang === 'en');
            updateShareLinks();
            updateUI();
        }

        // Share Link Update Logic
        function updateShareLinks() {
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(translations[currentLang].shareTitle);
            document.getElementById('shareX').href = `https://twitter.com/intent/tweet?url=${url}&text=${text}`;
            document.getElementById('shareLine').href = `https://social-plugins.line.me/lineit/share?url=${url}`;
            document.getElementById('shareFb').href = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
        }

        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                const msg = currentLang === 'ja' ? "ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼" : "Link copied!";
                alert(msg);
            });
        }

        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('open');
            overlay.style.display = menu.classList.contains('open') ? 'block' : 'none';
        }

        function checkPass() {
            const input = document.getElementById('passInput').value;
            const msg = document.getElementById('supporterMsg');
            if (input === PASS_CODE) {
                activateSupernovaMode(true);
                msg.innerHTML = translations[currentLang].supporterOk;
                speak(currentLang === 'ja' ? "ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ´ã‚¡ãƒ¢ãƒ¼ãƒ‰ã€èµ·å‹•ã€‚å¿œæ´ã‚ã‚ŠãŒã¨ã†ï¼" : "Special mode activated. Thank you!");
                document.getElementById('passInput').value = "";
            } else {
                msg.innerText = currentLang === 'ja' ? "ã‚³ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™" : "Invalid Code";
            }
        }

        function activateSupernovaMode(save = false) {
            isSupernovaMode = true;
            document.body.classList.add('supernova-active');
            document.documentElement.style.setProperty('--accent-color', '#FFD700');
            document.documentElement.style.setProperty('--supernova-glow', '0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 255, 255, 0.4)');
            shootingStarProbability = 1 / 150; 
            document.getElementById('resetModeBtn').classList.add('show');
            if (save) localStorage.setItem('timeBankSupernova', 'true');
            explode(100, '#FFD700');
        }

        function deactivateSupernovaMode(save = false) {
            isSupernovaMode = false;
            document.body.classList.remove('supernova-active');
            document.documentElement.style.setProperty('--accent-color', '#00f2ff');
            document.documentElement.style.setProperty('--supernova-glow', '0 0 20px rgba(0, 242, 255, 0.5)');
            shootingStarProbability = 1 / (60 * 30);
            document.getElementById('resetModeBtn').classList.remove('show');
            document.getElementById('supporterMsg').innerText = "";
            if (save) localStorage.removeItem('timeBankSupernova');
            explode(40, '#00f2ff');
        }

        let actualMs = 0, visualMs = 0, timerId = null, mode = null;
        let lastAnnouncedSec = null, isMuted = false;
        let particles = [], rotationAngle = 0;
        let baseMs = 0, startTime = 0;
        
        const timerCanvas = document.getElementById('timerCanvas'), ctx = timerCanvas.getContext('2d');
        const starCanvas = document.getElementById('starCanvas'), sctx = starCanvas.getContext('2d');
        const pauseBtn = document.getElementById('pauseBtn');

        const cyberGradients = [['#00f2ff', '#0066ff'], ['#00d4ff', '#0044ff'], ['#7000ff', '#4b0082'], ['#ff00f2', '#b000ff']];
        const novaGradients = [['#FFFFFF', '#FFD700'], ['#FFD700', '#FFA500'], ['#FFFACD', '#DAA520'], ['#FFD700', '#B8860B']];
        const usingGradients = [['#ff00ff', '#880088'], ['#ff3399', '#990033'], ['#ff0066', '#880033'], ['#cc00ff', '#660099'], ['#ff66cc', '#cc3399'], ['#ff00cc', '#660066']];

        let stars = [];
        let shootingStars = [];

        function initStars() {
            starCanvas.width = window.innerWidth; starCanvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 200; i++) {
                stars.push({ x: Math.random() * starCanvas.width, y: Math.random() * starCanvas.height, size: Math.random() * 1.8, vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2, opacity: Math.random() });
            }
        }
        window.addEventListener('resize', initStars); initStars();

        function createShootingStar() {
            const startX = Math.random() * starCanvas.width;
            const startY = Math.random() * (starCanvas.height / 2);
            const angle = Math.PI / 4 + (Math.random() - 0.5) * 0.2;
            const speed = isSupernovaMode ? 15 + Math.random() * 20 : 10 + Math.random() * 15;
            shootingStars.push({ x: startX, y: startY, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, opacity: 1.0 });
        }

        function drawStars() {
            sctx.clearRect(0, 0, starCanvas.width, starCanvas.height);
            if (isSupernovaMode) {
                const radial = sctx.createRadialGradient(starCanvas.width/2, starCanvas.height/2, 0, starCanvas.width/2, starCanvas.height/2, 400);
                radial.addColorStop(0, 'rgba(255, 200, 50, 0.15)');
                radial.addColorStop(1, 'rgba(0, 0, 0, 0)');
                sctx.fillStyle = radial;
                sctx.fillRect(0, 0, starCanvas.width, starCanvas.height);
            }
            stars.forEach(s => {
                s.x += s.vx * (isSupernovaMode ? 2 : 1); s.y += s.vy * (isSupernovaMode ? 2 : 1);
                if (s.x < 0) s.x = starCanvas.width; if (s.x > starCanvas.width) s.x = 0;
                if (s.y < 0) s.y = starCanvas.height; if (s.y > starCanvas.height) s.y = 0;
                sctx.beginPath(); sctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                sctx.fillStyle = isSupernovaMode ? `rgba(255, 240, 200, ${s.opacity})` : `rgba(255, 255, 255, ${s.opacity})`;
                sctx.fill();
            });
            if (Math.random() < shootingStarProbability) createShootingStar();
            shootingStars = shootingStars.filter(ss => {
                ss.x += ss.vx; ss.y += ss.vy; ss.opacity -= 0.02;
                if (ss.opacity <= 0) return false;
                sctx.beginPath();
                const grad = sctx.createLinearGradient(ss.x, ss.y, ss.x - ss.vx * 2, ss.y - ss.vy * 2);
                const starColor = isSupernovaMode ? '255, 230, 100' : '255, 255, 255';
                grad.addColorStop(0, `rgba(${starColor}, ${ss.opacity})`);
                grad.addColorStop(1, `rgba(${starColor}, 0)`);
                sctx.strokeStyle = grad; sctx.lineWidth = isSupernovaMode ? 3 : 2;
                sctx.moveTo(ss.x, ss.y); sctx.lineTo(ss.x - ss.vx * 2, ss.y - ss.vy * 2);
                sctx.stroke();
                return true;
            });
        }

        class Particle {
            constructor(type, color) {
                this.type = type; this.cx = timerCanvas.width / 2; this.cy = timerCanvas.height / 2;
                this.angle = Math.random() * Math.PI * 2; this.friction = 1.0;
                this.particleColor = color || '#FFFFFF';
                const speedBoost = isSupernovaMode ? 1.5 : 1.0;
                if (type === 'in') { this.radius = 250 + Math.random() * 50; this.speed = (0.005 + Math.random() * 0.01) * speedBoost; this.radialSpeed = (0.8 + Math.random() * 0.5) * speedBoost; this.life = 1.0; }
                else if (type === 'out') { this.radius = Math.random() * 20; this.speed = (Math.random() - 0.5) * 0.02; this.radialSpeed = (1.2 + Math.random() * 2) * speedBoost; this.life = 1.0; }
                else if (type === 'explode') { this.radius = Math.random() * 10; this.radialSpeed = (5 + Math.random() * 10) * speedBoost; this.friction = 0.95; this.life = 1.0; }
                this.size = (Math.random() * 2.0 + 0.5) * (isSupernovaMode ? 1.5 : 1);
            }
            update() {
                if (this.type === 'in') { this.angle += this.speed; this.radius -= this.radialSpeed; this.life = Math.min(1.0, (this.radius - 40) / 100); }
                else if (this.type === 'out') { this.angle += this.speed; this.radius += this.radialSpeed; this.life = (this.radius < 50) ? 0.2 : 1.0 - (this.radius / 250); }
                else if (this.type === 'explode') { this.radialSpeed *= this.friction; this.radius += this.radialSpeed; this.life -= 0.015; }
                this.x = this.cx + Math.cos(this.angle) * this.radius; this.y = this.cy + Math.sin(this.angle) * this.radius;
                return this.life > 0.01 && this.radius < 450 && (this.type === 'in' ? this.radius > 30 : true);
            }
            draw() { 
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); 
                if (mode === 'minus') ctx.fillStyle = '#ff66ff';
                else if (isSupernovaMode) ctx.fillStyle = '#FFFACD';
                else ctx.fillStyle = '#FFFFFF';
                ctx.globalAlpha = this.life * 0.8; ctx.fill(); ctx.globalAlpha = 1.0; 
            }
        }

        function explode(count, color) { for (let i = 0; i < count; i++) { particles.push(new Particle('explode', color)); } }
        function saveState() { const state = { actualMs, mode, startTime: mode ? startTime : null, baseMs: mode ? baseMs : actualMs }; localStorage.setItem('timeBankState_v4', JSON.stringify(state)); }
        function loadState() { if (localStorage.getItem('timeBankSupernova') === 'true') activateSupernovaMode(); const saved = localStorage.getItem('timeBankState_v4'); if (saved) { const state = JSON.parse(saved); actualMs = state.actualMs; if (state.mode && state.startTime) { baseMs = state.baseMs || actualMs; startTime = state.startTime; const elapsed = Date.now() - startTime; actualMs = baseMs + (state.mode === 'plus' ? elapsed : -elapsed); startTimer(state.mode, true); } } }
        
        function startTimer(newMode, isFromLoad = false) { 
            if (timerId) cancelAnimationFrame(timerId); 
            mode = newMode; 
            
            if (!isFromLoad) {
                if (mode === 'plus') speak(translations[currentLang].voiceCharge);
                else if (mode === 'minus') speak(translations[currentLang].voiceUse);
                
                baseMs = actualMs; 
                startTime = Date.now(); 
            } 
            
            pauseBtn.classList.add('show'); 
            saveState(); 
            const tick = () => { 
                const now = Date.now(); 
                const elapsed = now - startTime; 
                actualMs = baseMs + (mode === 'plus' ? elapsed : -elapsed); 
                const spawnRate = isSupernovaMode ? 0.5 : 0.3; 
                if (mode === 'plus' && Math.random() > (1 - spawnRate)) particles.push(new Particle('in')); 
                else if (mode === 'minus' && Math.random() > (1 - spawnRate + 0.05)) particles.push(new Particle('out')); 
                checkCountdown(); 
                timerId = requestAnimationFrame(tick); 
            }; 
            timerId = requestAnimationFrame(tick); 
        }

        function pauseTimer() { if(timerId) cancelAnimationFrame(timerId); timerId = null; mode = null; pauseBtn.classList.remove('show'); saveState(); }
        function clearTime() { if (Math.abs(actualMs) > 1000) explode(100); pauseTimer(); actualMs = 0; visualMs = 0; lastAnnouncedSec = null; localStorage.removeItem('timeBankState_v4'); }
        function addTime(amount) { const msToAdd = amount * 1000; actualMs += msToAdd; if (mode !== null) { baseMs += msToAdd; } saveState(); for(let i=0; i<20; i++) particles.push(new Particle(amount > 0 ? 'in' : 'out')); }
        function toggleMute() { isMuted = !isMuted; document.getElementById('alertToggle').classList.toggle('is-muted', isMuted); }
        function speak(text) { if (!isMuted) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = translations[currentLang].voiceLang; window.speechSynthesis.speak(u); } }
        function checkCountdown() { const currentSec = Math.floor(actualMs / 1000); if (mode === 'minus' && currentSec !== lastAnnouncedSec) { if (currentSec === 0) { explode(150, '#ff3b30'); speak(translations[currentLang].timeOver); sendNotification("TIME BANK", translations[currentLang].timeOverMsg); } else if (currentSec === 300 || currentSec === 60) { const mins = currentSec / 60; speak(translations[currentLang].left + " " + mins + " " + translations[currentLang].minutes); } lastAnnouncedSec = currentSec; } }
        function showHowTo() { document.getElementById('howToModal').style.display = 'flex'; if(document.getElementById('sideMenu').classList.contains('open')) toggleMenu(); }
        function closeHowTo() { document.getElementById('howToModal').style.display = 'none'; }
        function showParentsModal() { document.getElementById('parentsModal').style.display = 'flex'; if(document.getElementById('sideMenu').classList.contains('open')) toggleMenu(); }
        function closeParentsModal() { document.getElementById('parentsModal').style.display = 'none'; }

        function animate() {
            visualMs += (actualMs - visualMs) * 0.15;
            const rotSpeed = isSupernovaMode ? 1.5 : 1.0;
            if (mode === 'plus') rotationAngle += 0.008 * rotSpeed;
            else if (mode === 'minus') rotationAngle -= 0.015 * rotSpeed;
            else rotationAngle += 0.002;
            drawStars(); updateUI(); drawTimer(); requestAnimationFrame(animate);
        }

        function updateUI() {
            const absMs = Math.abs(Math.round(visualMs));
            const h = Math.floor(absMs / 3600000), m = Math.floor((absMs % 3600000) / 60000), s = Math.floor((absMs % 60000) / 1000), ms = Math.floor((absMs % 1000) / 10);
            document.getElementById('timeMain').innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            document.getElementById('timeSubM').innerText = String(s).padStart(2, '0');
            document.getElementById('timeSubMs').innerText = String(ms).padStart(2, '0');
            const isNegative = actualMs < 0;
            const label = document.getElementById('statusLabel');
            const timeDisplay = document.getElementById('timeMain');
            let textColor = 'white';

            if (isNegative) { 
                textColor = '#ff3b30'; 
                timeDisplay.style.textShadow = "0 0 15px rgba(255, 59, 48, 0.6)"; 
            } else if (mode === 'minus') { 
                textColor = '#ff66ff'; 
                timeDisplay.style.textShadow = "0 0 15px rgba(255, 102, 255, 0.6)"; 
            } else if (isSupernovaMode) { 
                textColor = '#FFD700'; 
                timeDisplay.style.textShadow = "0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 255, 255, 0.3)"; 
            } else { 
                timeDisplay.style.textShadow = "none"; 
            }

            if (isNegative) { 
                label.innerText = translations[currentLang].shortage; label.style.color = '#ff3b30'; label.classList.add('pulse-text'); 
            } else if (mode === 'plus') { 
                label.innerText = translations[currentLang].charging; label.style.color = isSupernovaMode ? '#FFD700' : 'white'; label.classList.add('pulse-text'); 
            } else if (mode === 'minus') { 
                label.innerText = translations[currentLang].using; label.style.color = '#ff66ff'; label.classList.add('pulse-text'); 
            } else { 
                label.innerText = ""; label.classList.remove('pulse-text'); 
            }
            document.getElementById('alertOverlay').classList.toggle('alert-active', isNegative);
            document.querySelectorAll('.time-main, .time-sub-m').forEach(el => el.style.color = textColor);
        }

        function drawTimer() {
            ctx.clearRect(0, 0, timerCanvas.width, timerCanvas.height);
            let cx = timerCanvas.width / 2, cy = timerCanvas.height / 2;
            const time = performance.now();
            const isUsingMode = (mode === 'minus');
            const isChargingMode = (mode === 'plus');
            const isNegative = (actualMs < 0);
            
            const pulseRate = (isUsingMode || isNegative) ? 400 : 800;
            const basePulse = (Math.sin(time / pulseRate) + 1) / 2;
            
            let heartBeat = 0;
            if (isSupernovaMode && isChargingMode) {
                const t = (time % 1000) / 1000; 
                heartBeat = Math.pow(Math.sin(t * Math.PI), 10) * 0.8 + Math.pow(Math.sin(t * Math.PI - 0.5), 10) * 0.5;
            }

            const baseRadius = 110;
            const ringSpacing = 16;

            for (let i = 0; i < 6; i++) {
                ctx.beginPath(); ctx.arc(cx, cy, baseRadius + (i * ringSpacing), 0, Math.PI * 2);
                ctx.strokeStyle = isSupernovaMode ? `rgba(255, 215, 0, 0.08)` : `rgba(255, 255, 255, 0.03)`;
                ctx.stroke();
            }
            const totalSeconds = visualMs / 1000, absSec = Math.abs(totalSeconds);
            
            let activeGradients;
            if (isNegative) {
                activeGradients = [['#ff0000', '#880000']];
            } else if (isUsingMode) {
                activeGradients = usingGradients;
            } else {
                activeGradients = isSupernovaMode ? novaGradients : cyberGradients;
            }

            for (let i = 0; i < 6; i++) {
                const radius = baseRadius + (i * ringSpacing), hourInSec = 3600;
                let progress = Math.max(0, Math.min(1, (absSec - i * hourInSec) / hourInSec));
                if (progress > 0) {
                    ctx.save(); ctx.translate(cx, cy); ctx.rotate(rotationAngle * (1 + i * 0.15));
                    ctx.beginPath();
                    if (totalSeconds >= 0) ctx.arc(0, 0, radius, 0, Math.PI * 2 * progress);
                    else ctx.arc(0, 0, radius, 0, -Math.PI * 2 * progress, true);
                    
                    const baseWidth = 3.0 + (basePulse * 2.0);
                    const baseShadow = (isSupernovaMode ? 15 : 8) + (basePulse * 10);
                    
                    ctx.lineWidth = baseWidth + (heartBeat * 6.0); 
                    ctx.shadowBlur = baseShadow + (heartBeat * 25); 
                    
                    const colorPair = activeGradients[i % activeGradients.length];
                    ctx.shadowColor = colorPair[0]; ctx.strokeStyle = colorPair[0];
                    ctx.lineCap = 'round'; ctx.stroke(); ctx.restore();
                }
            }
            particles = particles.filter(p => p.update() ? (p.draw(), true) : false);
        }
        
        setLanguage('ja'); loadState(); animate();
    </script>
</body>
</html>
