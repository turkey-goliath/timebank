<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>Time Bank - Cosmic Pulse Evolution</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --accent-color: #00f2ff;
        }

        body {
            background: radial-gradient(circle at center, #0a0a1a 0%, #020205 100%);
            color: white;
            font-family: 'Inter', 'Helvetica Neue', sans-serif;
            display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; overflow-x: hidden; user-select: none;
            touch-action: manipulation;
            padding-top: var(--safe-top);
            box-sizing: border-box;
        }

        #starCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none; }

        header {
            position: absolute; top: var(--safe-top); width: 100%;
            display: flex; align-items: center; justify-content: center; height: 60px; z-index: 100;
        }

        .logo-text {
            font-size: 24px; font-weight: 900; letter-spacing: 4px; color: #ffffff;
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(0, 242, 255, 0.3);
            display: flex; align-items: center;
        }
        .logo-text span { color: var(--accent-color); margin-right: 4px; }

        .menu-trigger {
            position: absolute; left: 20px; cursor: pointer;
            width: 30px; height: 30px; display: flex; flex-direction: column; justify-content: center; gap: 6px;
        }
        .menu-trigger span { width: 100%; height: 2px; background: white; transition: 0.3s; }
        
        .side-menu {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: rgba(10, 10, 26, 0.95); backdrop-filter: blur(15px);
            z-index: 200; transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            padding: 80px 30px; box-sizing: border-box; border-right: 1px solid rgba(255,255,255,0.1);
            overflow-y: auto;
        }
        .side-menu.open { left: 0; box-shadow: 20px 0 50px rgba(0,0,0,0.5); }
        .menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 150; }
        
        .menu-section { margin-bottom: 30px; }
        .menu-section h3 { font-size: 11px; color: var(--accent-color); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 12px; opacity: 0.8; }
        .menu-item { color: #888; text-decoration: none; display: block; padding: 10px 0; font-size: 15px; cursor: pointer; transition: 0.3s; }
        .menu-item.active { color: white; font-weight: bold; }
        .desc-text { font-size: 13px; line-height: 1.6; color: #aaa; white-space: pre-wrap; }
        .desc-highlight { color: #fff; font-weight: bold; display: block; margin-bottom: 15px; font-size: 15px; }

        /* Modals */
        .custom-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            z-index: 9999;
            display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: rgba(10, 10, 26, 0.98);
            width: 85%; max-width: 420px; padding: 30px;
            border-radius: 20px; border: 2px solid var(--accent-color);
            text-align: center; 
            box-shadow: 0 0 50px rgba(0, 0, 0, 1), 0 0 30px rgba(0, 242, 255, 0.3);
            max-height: 85vh; overflow-y: auto;
            box-sizing: border-box;
        }

        .modal-step { margin-bottom: 25px; text-align: center; }
        .step-num { color: var(--accent-color); font-weight: bold; font-size: 12px; display: block; margin-bottom: 5px; letter-spacing: 2px; }
        .step-title { font-size: 18px; font-weight: bold; display: block; margin-bottom: 8px; text-shadow: 0 0 10px var(--accent-color); }
        .step-desc { font-size: 13px; color: #ccc; line-height: 1.5; }
        
        .close-btn { 
            background: transparent; color: var(--accent-color); border: 2px solid var(--accent-color); 
            padding: 12px 50px; border-radius: 30px; font-weight: bold; cursor: pointer; 
            margin-top: 10px; transition: 0.3s; text-transform: uppercase; letter-spacing: 2px;
        }
        .close-btn:active { background: var(--accent-color); color: #000; transform: scale(0.9); }

        /* UI elements */
        .alert-toggle { position: absolute; top: 15px; right: 20px; cursor: pointer; width: 30px; height: 30px; opacity: 0.4; transition: 0.3s; z-index: 100; }
        .alert-toggle.active { opacity: 1; }
        .bell-icon { width: 20px; height: 20px; border: 2px solid white; border-radius: 10px 10px 2px 2px; position: relative; margin: 2px auto; }
        .bell-icon::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 6px; height: 4px; background: white; border-radius: 0 0 3px 3px; }
        .mute-line { position: absolute; top: 50%; left: 50%; width: 34px; height: 2px; background: #ff3b30; transform: translate(-50%, -50%) rotate(45deg); display: none; }
        .is-muted .mute-line { display: block; }

        #alertOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: -1; }
        @keyframes pulse-red {
            0% { box-shadow: inset 0 0 40px rgba(255, 59, 48, 0); }
            50% { box-shadow: inset 0 0 120px rgba(255, 59, 48, 0.4); }
            100% { box-shadow: inset 0 0 40px rgba(255, 59, 48, 0); }
        }
        .alert-active { animation: pulse-red 2s infinite ease-in-out; }

        .app-wrapper { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; max-width: 800px; margin-top: 40px; }
        .quick-controls { display: flex; flex-direction: column; gap: 12px; }
        .btn-quick { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #888; width: 55px; padding: 10px 0; border-radius: 8px; cursor: pointer; font-size: 11px; transition: all 0.2s; touch-action: manipulation; }
        .btn-quick:active { transform: scale(0.9); background: rgba(255, 255, 255, 0.2); color: #fff; }

        .timer-container { position: relative; width: 450px; height: 450px; display: flex; align-items: center; justify-content: center; }
        #timerCanvas { position: absolute; top: 0; left: 0; z-index: 5; max-width: 100%; height: auto; }
        .timer-info { text-align: center; z-index: 10; pointer-events: none; }
        .status-label { font-size: 16px; letter-spacing: 2px; height: 24px; margin-bottom: 5px; padding-top: 15px; font-weight: bold; color: white; }
        .pulse-text { animation: soft-pulse 2.5s infinite ease-in-out; }
        @keyframes soft-pulse { 0%, 100% { opacity: 0.2; transform: scale(0.98); } 50% { opacity: 1; transform: scale(1); } }
        .time-main { font-size: 52px; font-weight: bold; line-height: 1; letter-spacing: 2px; }
        .time-sub-m { font-size: 28px; opacity: 0.8; margin-top: 5px; }
        .time-sub-ms { font-size: 18px; opacity: 0.5; font-family: monospace; }

        .bottom-area { margin-top: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding-bottom: env(safe-area-inset-bottom, 20px); }
        .controls { display: flex; align-items: center; gap: 50px; height: 80px; }
        .btn-start-wrap { text-align: center; width: 75px; cursor: pointer; background: none; border: none; color: white; transition: 0.2s; touch-action: manipulation; }
        .btn-start-wrap span { font-size: 32px; display: block; font-weight: 200; }
        .btn-start-wrap label { font-size: 11px; opacity: 0.8; cursor: pointer; letter-spacing: 1px; display: block; }
        .btn-pause { width: 65px; height: 65px; background-color: #ff3b30; border: none; border-radius: 50%; color: white; font-size: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 20px rgba(255, 59, 48, 0.4); opacity: 0; transform: scale(0.5); transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); visibility: hidden; touch-action: manipulation; }
        .btn-pause.show { visibility: visible; opacity: 1; transform: scale(1); }
        .clear-btn { background: transparent; border: 1px solid #333; color: #555; padding: 8px 60px; border-radius: 10px; cursor: pointer; font-size: 11px; letter-spacing: 2px; transition: 0.3s; touch-action: manipulation; }

        @media (max-width: 600px) {
            body { justify-content: flex-start; }
            header { height: 50px; }
            .logo-text { font-size: 18px; letter-spacing: 3px; }
            .app-wrapper { flex-direction: column; gap: 15px; margin-top: 60px; }
            .timer-container { width: 300px; height: 300px; order: 1; }
            #timerCanvas { width: 300px; height: 300px; }
            .time-main { font-size: 36px; }
            .quick-controls { flex-direction: row; flex-wrap: wrap; justify-content: center; gap: 8px; order: 2; width: 95%; }
            .btn-quick { width: 70px; padding: 12px 0; font-size: 12px; }
            .bottom-area { order: 3; margin-top: 15px; }
        }
    </style>
</head>
<body>
    <canvas id="starCanvas"></canvas>

    <header>
        <div class="menu-trigger" onclick="toggleMenu()">
            <span></span><span></span><span></span>
        </div>
        <div class="logo-text">TIME<span>BANK</span></div>
        <div class="alert-toggle active" id="alertToggle" onclick="toggleMute()">
            <div class="bell-icon"></div>
            <div class="mute-line"></div>
        </div>
    </header>

    <div class="menu-overlay" id="menuOverlay" onclick="toggleMenu()"></div>
    <div class="side-menu" id="sideMenu">
        <div class="menu-section">
            <h3 id="langHeader">Language</h3>
            <div id="btnJp" class="menu-item active" onclick="setLanguage('ja')">æ—¥æœ¬èª</div>
            <div id="btnEn" class="menu-item" onclick="setLanguage('en')">English</div>
        </div>
        <div class="menu-section">
            <h3 id="howToHeader">GUIDE</h3>
            <div id="btnGuide" class="menu-item" onclick="showHowTo()">ä½¿ã„æ–¹ã‚’è¦‹ã‚‹</div>
        </div>
        <div class="menu-section">
            <h3 id="parentsHeader">FOR PARENTS</h3>
            <div id="btnParents" class="menu-item" onclick="showParentsModal()">ä¿è­·è€…ã®æ–¹ã¸</div>
        </div>
        <div class="menu-section">
            <h3 id="devHeader">DEVELOPMENT</h3>
            <div id="devDesc" class="desc-text"></div>
        </div>
    </div>

    <div id="howToModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-step">
                <span class="step-num">MISSION 01</span>
                <span class="step-title">æ™‚é–“ã‚’ãƒãƒ£ãƒ¼ã‚¸</span>
                <p class="step-desc">å‹‰å¼·ã‚„èª­æ›¸ã‚’ã™ã‚‹ã¨ãã¯ã€Œï¼‹è²¯ã‚ã‚‹ã€ã‚’èµ·å‹•ã€‚æœªæ¥ã®éŠã³ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’è“„ãˆã‚ˆã†ã€‚</p>
            </div>
            <div class="modal-step">
                <span class="step-num">MISSION 02</span>
                <span class="step-title">ã‚¨ãƒãƒ«ã‚®ãƒ¼è§£æ”¾</span>
                <p class="step-desc">éŠã³ã®æ™‚é–“ã¯ã€Œãƒ¼ä½¿ã†ã€ã‚’èµ·å‹•ã€‚è²¯ã‚ãŸåˆ†ã ã‘ã€å…¨åŠ›ã§æ¥½ã—ã‚€ã®ãŒå®‡å®™ã®ãƒ«ãƒ¼ãƒ«ã ï¼</p>
            </div>
            <div class="modal-step">
                <span class="step-num">GOLDEN RATIO</span>
                <span class="step-title">ã€Œ1ï¼š1ã€ã®å‡è¡¡</span>
                <p class="step-desc">å­¦ã¶æ™‚é–“ã¨éŠã¶æ™‚é–“ã‚’åŒã˜ã«ã™ã‚‹ã€‚ã“ã‚ŒãŒæœ€å¼·ã®ã‚¿ã‚¤ãƒ ãƒã‚¹ã‚¿ãƒ¼ã¸ã®é“ã€‚</p>
            </div>
            <button class="close-btn" onclick="closeHowTo()">Warp Start</button>
        </div>
    </div>

    <div id="parentsModal" class="custom-modal">
        <div class="modal-content" style="text-align: left;">
            <div id="parentsContent"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="close-btn" onclick="closeParentsModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="alertOverlay"></div>

    <div class="app-wrapper">
        <div class="quick-controls">
            <button class="btn-quick" onclick="addTime(-1800)">-30m</button>
            <button class="btn-quick" onclick="addTime(-900)">-15m</button>
            <button class="btn-quick" onclick="addTime(-300)">-5m</button>
            <button class="btn-quick" onclick="addTime(-60)">-1m</button>
        </div>

        <div class="timer-container">
            <canvas id="timerCanvas" width="450" height="450"></canvas>
            <div class="timer-info" id="timerInfo">
                <div id="statusLabel" class="status-label"></div>
                <div id="timeMain" class="time-main">00:00</div>
                <div id="timeSubM" class="time-sub-m">00</div>
                <div id="timeSubMs" class="time-sub-ms">00</div>
            </div>
        </div>

        <div class="quick-controls">
            <button class="btn-quick" onclick="addTime(1800)">+30m</button>
            <button class="btn-quick" onclick="addTime(900)">+15m</button>
            <button class="btn-quick" onclick="addTime(300)">+5m</button>
            <button class="btn-quick" onclick="addTime(60)">+1m</button>
        </div>
    </div>

    <div class="bottom-area">
        <div class="controls">
            <button class="btn-start-wrap" onclick="startTimer('minus')">
                <span>ãƒ¼</span><label id="labelUse">ä½¿ã†</label>
            </button>
            <button id="pauseBtn" class="btn-pause" onclick="pauseTimer()">||</button>
            <button class="btn-start-wrap" onclick="startTimer('plus')">
                <span>ï¼‹</span><label id="labelCharge">è²¯ã‚ã‚‹</label>
            </button>
        </div>
        <button id="resetBtn" class="clear-btn" onclick="clearTime()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <script>
        // --- é€šçŸ¥è¨­å®š ---
        if ("Notification" in window) {
            if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                Notification.requestPermission();
            }
        }

        function sendNotification(title, body) {
            if ("Notification" in window && Notification.permission === "granted") {
                new Notification(title, { body: body });
            }
        }

        const translations = {
            ja: {
                use: "ä½¿ã†", charge: "è²¯ã‚ã‚‹", reset: "ãƒªã‚»ãƒƒãƒˆ", using: "ä½¿ç”¨ä¸­", charging: "ãƒãƒ£ãƒ¼ã‚¸ä¸­", shortage: "æ™‚é–“ãŒè¶³ã‚Šã¾ã›ã‚“",
                devHeader: "DEVELOPMENT", guideBtn: "ä½¿ã„æ–¹ã‚’è¦‹ã‚‹", parentsHeader: "FOR PARENTS", parentsBtn: "ä¿è­·è€…ã®æ–¹ã¸",
                devDesc: "<span class='desc-highlight'>ã€Œå…¨åŠ›ã§å­¦ã³ã€å…¨åŠ›ã§éŠã¼ã†ã€</span>\n\nTime Bankã¯ã€å­ã©ã‚‚ãŸã¡ã®æ™‚é–“ã‚’ã€Œè²¯ã‚ã‚‹ã€ã€Œä½¿ã†ã€ã¨ã„ã†æ¦‚å¿µã§è¦–è¦šåŒ–ã—ã€æ—¥ã€…ã®æ´»å‹•ã‚’ã‚²ãƒ¼ãƒ ã®ã‚ˆã†ã«ç®¡ç†ãƒ»æ”¹å–„ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚",
                parentsBody: `
                    <h2 style="color:var(--accent-color); font-size:20px; margin-bottom:15px; text-align:center;">åˆ¶ä½œã®æƒ³ã„</h2>
                    <p style="font-size:13px; line-height:1.6; color:#aaa; margin-bottom:20px;">
                        ã“ã®ã‚¢ãƒ—ãƒªã¯ã€ã‚ã‚‹è¦ªã®ã€Œå­ã©ã‚‚ã«ã‚²ãƒ¼ãƒ ã‚’æ€ã†å­˜åˆ†æ¥½ã—ã‚“ã§ã»ã—ã„ã€ã§ã‚‚ãƒãƒ©ãƒ³ã‚¹ã‚‚å¤§åˆ‡ã«ã—ã¦ã»ã—ã„ã€ã¨ã„ã†è‘›è—¤ã‹ã‚‰ç”Ÿã¾ã‚Œã¾ã—ãŸã€‚<br><br>
                        Time Bankã¯ã€æ™‚é–“ã‚’ã€Œè²¯ã‚ã‚‹ï¼ˆæŠ•è³‡ï¼‰ã€ã¨ã€Œä½¿ã†ï¼ˆæ¶ˆè²»ï¼‰ã€ã¨ã„ã†<b>éŠ€è¡Œã®ä»•çµ„ã¿</b>ã§è¦–è¦šåŒ–ã—ã€å­ã©ã‚‚è‡ªèº«ãŒè‡ªå¾‹çš„ã«å‹•ããã£ã‹ã‘ã‚’ä½œã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
                    </p>
                    <h3 style="color:var(--accent-color); font-size:15px; margin-bottom:10px;">ğŸ’¡ åŠ¹æœçš„ãªä½¿ã„æ–¹ã®ãƒ’ãƒ³ãƒˆ</h3>
                    <div style="font-size:13px; line-height:1.6; color:#ccc;">
                        <b>1. ã€Œ1:1ã®æ³•å‰‡ã€ã‹ã‚‰å§‹ã‚ã‚‹</b><br>
                        ã€Œ30åˆ†å‹‰å¼·ã—ãŸã‚‰30åˆ†éŠã¹ã‚‹ã€ã¨ã„ã†ã‚·ãƒ³ãƒ—ãƒ«ãªæ¯”ç‡ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆã€‚ç­‰ä¾¡äº¤æ›ã®æ„Ÿè¦šãŒã‚¿ã‚¤ãƒ ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã®åŸºç¤ã«ãªã‚Šã¾ã™ã€‚<br><br>
                        <b>2. ã€Œå‰å€Ÿã‚Šã€ã‚’è¨±å®¹ã™ã‚‹</b><br>
                        æ™‚é–“ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã£ã¦ã‚‚OKã€‚ã€Œæœªæ¥ã®è‡ªåˆ†ã¸ã®å€Ÿé‡‘ã€ã¨ã—ã¦ã€å¾Œã§ãƒãƒ£ãƒ¼ã‚¸ã™ã‚‹è²¬ä»»æ„Ÿã‚’è‚²ã¦ã¾ã™ã€‚<br><br>
                        <b>3. æˆæœã‚’ä¸€ç·’ã«å–œã¶</b><br>
                        è²¯ã¾ã£ãŸæ•°å­—ã‚’ã€Œå®‡å®™ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒãƒ‘ãƒ³ãƒ‘ãƒ³ã ã­ï¼ã€ã¨ãƒã‚¸ãƒ†ã‚£ãƒ–ã«è©•ä¾¡ã—ã¦ã‚ã’ã¦ãã ã•ã„ã€‚
                    </div>`,
                timeOver: "æ™‚é–“çµ‚äº†", timeOverMsg: "æ™‚é–“ãŒãªããªã‚Šã¾ã—ãŸï¼", left: "æ®‹ã‚Š", minutes: "åˆ†ã§ã™", voiceLang: "ja-JP"
            },
            en: {
                use: "USE", charge: "CHARGE", reset: "RESET", using: "USING", charging: "CHARGING", shortage: "TIME SHORTAGE",
                devHeader: "DEVELOPMENT", guideBtn: "GUIDE", parentsHeader: "FOR PARENTS", parentsBtn: "For Parents",
                devDesc: "<span class='desc-highlight'>\"Learn Hard, Play Hard\"</span>\n\nTime Bank is a tool to visualize time as 'saving' and 'spending,' helping children manage and improve their daily activities like a game.",
                parentsBody: `
                    <h2 style="color:var(--accent-color); font-size:20px; margin-bottom:15px; text-align:center;">Our Vision</h2>
                    <p style="font-size:13px; line-height:1.6; color:#aaa; margin-bottom:20px;">
                        Time Bank was born from a parent's desire: "I want my child to enjoy games to the fullest, but also value balance."<br><br>
                        By visualizing time through "Saving" and "Spending," this tool encourages children to manage their own time like a game.
                    </p>
                    <h3 style="color:var(--accent-color); font-size:15px; margin-bottom:10px;">ğŸ’¡ Usage Tips</h3>
                    <div style="font-size:13px; line-height:1.6; color:#ccc;">
                        <b>1. Start with the "1:1 Rule"</b><br>
                        Example: 30 mins of study = 30 mins of play. This builds the foundation of time management.<br><br>
                        <b>2. Allow "Overdrafts"</b><br>
                        It's okay to go into the negative. Treat it as a "loan from the future self" to teach responsibility.<br><br>
                        <b>3. Celebrate the Numbers</b><br>
                        Praise them when the bank is full! Visualizing effort leads to a sense of accomplishment.
                    </div>`,
                timeOver: "Time over", timeOverMsg: "Time is up!", left: "", minutes: "minutes left", voiceLang: "en-US"
            }
        };

        let currentLang = 'ja';
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('labelUse').innerText = translations[lang].use;
            document.getElementById('labelCharge').innerText = translations[lang].charge;
            document.getElementById('resetBtn').innerText = translations[lang].reset;
            document.getElementById('devHeader').innerText = translations[lang].devHeader;
            document.getElementById('devDesc').innerHTML = translations[lang].devDesc;
            document.getElementById('howToHeader').innerText = translations[lang].guideBtn === "GUIDE" ? "GUIDE" : "GUIDE"; // Consistency
            document.getElementById('btnGuide').innerText = translations[lang].guideBtn;
            document.getElementById('parentsHeader').innerText = translations[lang].parentsHeader;
            document.getElementById('btnParents').innerText = translations[lang].parentsBtn;
            document.getElementById('parentsContent').innerHTML = translations[lang].parentsBody;
            
            document.getElementById('btnJp').classList.toggle('active', lang === 'ja');
            document.getElementById('btnEn').classList.toggle('active', lang === 'en');
            updateUI();
        }

        // Modal Controls
        function showHowTo() {
            document.getElementById('howToModal').style.display = 'flex';
            if(document.getElementById('sideMenu').classList.contains('open')) toggleMenu();
        }
        function closeHowTo() { document.getElementById('howToModal').style.display = 'none'; }
        
        function showParentsModal() {
            document.getElementById('parentsModal').style.display = 'flex';
            if(document.getElementById('sideMenu').classList.contains('open')) toggleMenu();
        }
        function closeParentsModal() { document.getElementById('parentsModal').style.display = 'none'; }

        function toggleMenu() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            menu.classList.toggle('open');
            overlay.style.display = menu.classList.contains('open') ? 'block' : 'none';
        }

        // --- Core Logic ---
        let actualMs = 0, visualMs = 0, timerId = null, mode = null;
        let lastAnnouncedSec = null, isMuted = false;
        let particles = [], rotationAngle = 0;
        let baseMs = 0, startTime = 0;
        
        const timerCanvas = document.getElementById('timerCanvas'), ctx = timerCanvas.getContext('2d');
        const starCanvas = document.getElementById('starCanvas'), sctx = starCanvas.getContext('2d');
        const pauseBtn = document.getElementById('pauseBtn');
        const cyberGradients = [['#00f2ff', '#0066ff'], ['#00d4ff', '#0044ff'], ['#7000ff', '#4b0082'], ['#ff00f2', '#b000ff']];
        
        let stars = [];
        let shootingStars = [];

        function initStars() {
            starCanvas.width = window.innerWidth; starCanvas.height = window.innerHeight;
            stars = [];
            for (let i = 0; i < 150; i++) {
                stars.push({ x: Math.random() * starCanvas.width, y: Math.random() * starCanvas.height, size: Math.random() * 1.5, vx: (Math.random() - 0.5) * 0.2, vy: (Math.random() - 0.5) * 0.2, opacity: Math.random() });
            }
        }
        window.addEventListener('resize', initStars); initStars();

        function createShootingStar() {
            const startX = Math.random() * starCanvas.width;
            const startY = Math.random() * (starCanvas.height / 2);
            const angle = Math.PI / 4 + (Math.random() - 0.5) * 0.2;
            const speed = 10 + Math.random() * 15;
            shootingStars.push({ x: startX, y: startY, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, opacity: 1.0 });
        }

        function drawStars() {
            sctx.clearRect(0, 0, starCanvas.width, starCanvas.height);
            stars.forEach(s => {
                s.x += s.vx; s.y += s.vy;
                if (s.x < 0) s.x = starCanvas.width; if (s.x > starCanvas.width) s.x = 0;
                if (s.y < 0) s.y = starCanvas.height; if (s.y > starCanvas.height) s.y = 0;
                sctx.beginPath(); sctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                sctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`; sctx.fill();
            });
            if (Math.random() < 1 / (60 * 30)) createShootingStar();
            shootingStars = shootingStars.filter(ss => {
                ss.x += ss.vx; ss.y += ss.vy; ss.opacity -= 0.02;
                if (ss.opacity <= 0) return false;
                sctx.beginPath();
                const grad = sctx.createLinearGradient(ss.x, ss.y, ss.x - ss.vx * 2, ss.y - ss.vy * 2);
                grad.addColorStop(0, `rgba(255, 255, 255, ${ss.opacity})`);
                grad.addColorStop(1, `rgba(255, 255, 255, 0)`);
                sctx.strokeStyle = grad; sctx.lineWidth = 2;
                sctx.moveTo(ss.x, ss.y); sctx.lineTo(ss.x - ss.vx * 2, ss.y - ss.vy * 2);
                sctx.stroke();
                return true;
            });
        }

        class Particle {
            constructor(type, color = '#ffffff') {
                this.type = type; this.cx = timerCanvas.width / 2; this.cy = timerCanvas.height / 2;
                this.color = color; this.angle = Math.random() * Math.PI * 2; this.friction = 1.0;
                if (type === 'in') { this.radius = 220 + Math.random() * 50; this.speed = 0.005 + Math.random() * 0.01; this.radialSpeed = 0.8 + Math.random() * 0.5; this.life = 1.0; }
                else if (type === 'out') { this.radius = Math.random() * 20; this.speed = (Math.random() - 0.5) * 0.02; this.radialSpeed = 1.2 + Math.random() * 2; this.life = 1.0; }
                else if (type === 'explode') { this.radius = Math.random() * 10; this.radialSpeed = 5 + Math.random() * 10; this.friction = 0.95; this.life = 1.0; }
                this.size = Math.random() * 2.0 + 0.5;
            }
            update() {
                if (this.type === 'in') { this.angle += this.speed; this.radius -= this.radialSpeed; this.life = Math.min(1.0, (this.radius - 40) / 100); }
                else if (this.type === 'out') { this.angle += this.speed; this.radius += this.radialSpeed; this.life = (this.radius < 50) ? 0.2 : 1.0 - (this.radius / 250); }
                else if (this.type === 'explode') { this.radialSpeed *= this.friction; this.radius += this.radialSpeed; this.life -= 0.015; }
                this.x = this.cx + Math.cos(this.angle) * this.radius; this.y = this.cy + Math.sin(this.angle) * this.radius;
                return this.life > 0.01 && this.radius < 400 && (this.type === 'in' ? this.radius > 30 : true);
            }
            draw() { ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fillStyle = this.color; ctx.globalAlpha = this.life * 0.8; ctx.fill(); ctx.globalAlpha = 1.0; }
        }

        function explode(count, color) { for (let i = 0; i < count; i++) { particles.push(new Particle('explode', color)); } }

        function saveState() {
            const state = { actualMs, mode, startTime: mode ? startTime : null, baseMs: mode ? baseMs : actualMs };
            localStorage.setItem('timeBankState_v2', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('timeBankState_v2');
            if (saved) {
                const state = JSON.parse(saved);
                actualMs = state.actualMs;
                if (state.mode && state.startTime) {
                    baseMs = state.baseMs || actualMs;
                    startTime = state.startTime;
                    const elapsed = Date.now() - startTime;
                    actualMs = baseMs + (state.mode === 'plus' ? elapsed : -elapsed);
                    startTimer(state.mode, true);
                }
            }
        }

        function startTimer(newMode, isFromLoad = false) {
            if (timerId) cancelAnimationFrame(timerId);
            mode = newMode;
            if (!isFromLoad) { baseMs = actualMs; startTime = Date.now(); }
            pauseBtn.classList.add('show');
            saveState();
            const tick = () => {
                const now = Date.now();
                const elapsed = now - startTime;
                actualMs = baseMs + (mode === 'plus' ? elapsed : -elapsed);
                if (mode === 'plus' && Math.random() > 0.3) particles.push(new Particle('in'));
                else if (mode === 'minus' && Math.random() > 0.35) particles.push(new Particle('out'));
                checkCountdown();
                timerId = requestAnimationFrame(tick);
            };
            timerId = requestAnimationFrame(tick);
        }

        function pauseTimer() {
            if(timerId) cancelAnimationFrame(timerId);
            timerId = null; mode = null;
            pauseBtn.classList.remove('show');
            saveState();
        }

        function clearTime() { 
            if (Math.abs(actualMs) > 1000) explode(100, '#ffffff');
            pauseTimer(); actualMs = 0; visualMs = 0; lastAnnouncedSec = null; 
            localStorage.removeItem('timeBankState_v2');
        }

        function addTime(amount) {
            const msToAdd = amount * 1000;
            actualMs += msToAdd;
            if (mode !== null) { baseMs += msToAdd; }
            saveState();
            for(let i=0; i<15; i++) particles.push(new Particle(amount > 0 ? 'in' : 'out'));
        }

        function toggleMute() { isMuted = !isMuted; document.getElementById('alertToggle').classList.toggle('is-muted', isMuted); }
        function speak(text) { if (!isMuted) { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = translations[currentLang].voiceLang; window.speechSynthesis.speak(u); } }

        function checkCountdown() {
            const currentSec = Math.floor(actualMs / 1000);
            if (mode === 'minus' && currentSec !== lastAnnouncedSec) {
                if (currentSec === 0) {
                    explode(150, '#ff3b30');
                    speak(translations[currentLang].timeOver);
                    sendNotification("TIME BANK", translations[currentLang].timeOverMsg);
                } 
                else if (currentSec === 300 || currentSec === 60) {
                    const mins = currentSec / 60;
                    const msg = translations[currentLang].left + " " + mins + " " + translations[currentLang].minutes;
                    speak(msg);
                }
                lastAnnouncedSec = currentSec;
            }
        }

        function animate() {
            visualMs += (actualMs - visualMs) * 0.15;
            if (mode === 'plus') rotationAngle += 0.008;
            else if (mode === 'minus') rotationAngle -= 0.015;
            else rotationAngle += 0.002;
            drawStars();
            updateUI();
            drawTimer();
            requestAnimationFrame(animate);
        }

        function updateUI() {
            const absMs = Math.abs(Math.round(visualMs));
            const h = Math.floor(absMs / 3600000), m = Math.floor((absMs % 3600000) / 60000), s = Math.floor((absMs % 60000) / 1000), ms = Math.floor((absMs % 1000) / 10);
            document.getElementById('timeMain').innerText = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            document.getElementById('timeSubM').innerText = String(s).padStart(2, '0');
            document.getElementById('timeSubMs').innerText = String(ms).padStart(2, '0');
            
            const isNegative = actualMs < 0;
            const label = document.getElementById('statusLabel');
            if (isNegative) {
                label.innerText = translations[currentLang].shortage;
                label.style.color = '#ff3b30';
                label.classList.add('pulse-text');
            } else if (mode === 'plus') {
                label.innerText = translations[currentLang].charging;
                label.style.color = 'white';
                label.classList.add('pulse-text');
            } else if (mode === 'minus') {
                label.innerText = translations[currentLang].using;
                label.style.color = 'white';
                label.classList.add('pulse-text');
            } else {
                label.innerText = "";
                label.classList.remove('pulse-text');
            }
            document.getElementById('alertOverlay').classList.toggle('alert-active', isNegative);
            document.querySelectorAll('.time-main, .time-sub-m').forEach(el => el.style.color = isNegative ? '#ff3b30' : 'white');
        }

        function drawTimer() {
            ctx.clearRect(0, 0, timerCanvas.width, timerCanvas.height);
            let cx = timerCanvas.width / 2, cy = timerCanvas.height / 2;
            const time = performance.now();
            const pulseRate = (actualMs < 0) ? 250 : 800;
            const pulse = (Math.sin(time / pulseRate) + 1) / 2;
            for (let i = 0; i < 6; i++) {
                ctx.beginPath(); ctx.arc(cx, cy, 125 + (i * 18), 0, Math.PI * 2);
                ctx.strokeStyle = `rgba(255, 255, 255, 0.03)`; ctx.stroke();
            }
            const totalSeconds = visualMs / 1000, absSec = Math.abs(totalSeconds);
            const activeGradients = (totalSeconds >= 0) ? cyberGradients : [['#FF4D4D', '#B30000']];
            for (let i = 0; i < 6; i++) {
                const radius = 125 + (i * 18), hourInSec = 3600;
                let progress = Math.max(0, Math.min(1, (absSec - i * hourInSec) / hourInSec));
                if (progress > 0) {
                    ctx.save(); ctx.translate(cx, cy); ctx.rotate(rotationAngle * (1 + i * 0.15));
                    ctx.beginPath();
                    if (totalSeconds >= 0) ctx.arc(0, 0, radius, 0, Math.PI * 2 * progress);
                    else ctx.arc(0, 0, radius, 0, -Math.PI * 2 * progress, true);
                    ctx.lineWidth = ((totalSeconds < 0) ? 4.5 : 3.0) + (pulse * (totalSeconds < 0 ? 3.0 : 2.0));
                    ctx.shadowBlur = (totalSeconds < 0 ? 15 : 8) + (pulse * 12);
                    ctx.shadowColor = activeGradients[i % activeGradients.length][0];
                    ctx.strokeStyle = activeGradients[i % activeGradients.length][0];
                    ctx.lineCap = 'round'; ctx.stroke(); ctx.restore();
                }
            }
            particles = particles.filter(p => { if (p.update()) { p.draw(); return true; } return false; });
        }
        
        setLanguage('ja');
        loadState();
        animate();
    </script>
</body>
</html>
